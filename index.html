<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="Ares" type="application/atom+xml">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://obsessed.top').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","Manual define the sidebar width. If commented, will be default for":null,"Muse | Mist":320,"Pisces | Gemini":240,"width":200,"display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="最重要的是，别放弃希望">
<meta property="og:type" content="website">
<meta property="og:title" content="Ares">
<meta property="og:url" content="http://obsessed.top/index.html">
<meta property="og:site_name" content="Ares">
<meta property="og:description" content="最重要的是，别放弃希望">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Ares">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://obsessed.top/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Ares</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ares</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Above all, don't lose hope.</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/04/22/python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E5%AE%9E%E7%8E%B0%E5%8F%88%E6%8B%8D%E4%BA%91-upyun-com-%E5%AD%98%E5%82%A8%E7%9A%84%E5%BC%82%E6%AD%A5%E6%8B%96%E6%8B%BD%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/22/python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E5%AE%9E%E7%8E%B0%E5%8F%88%E6%8B%8D%E4%BA%91-upyun-com-%E5%AD%98%E5%82%A8%E7%9A%84%E5%BC%82%E6%AD%A5%E6%8B%96%E6%8B%BD%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD/" class="post-title-link" itemprop="url">python3.7+Django2.0.4配合vue.js2.0实现又拍云(upyun.com)存储的异步拖拽文件上传功能</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-04-22 17:09:53 / 修改时间：18:25:21" itemprop="dateCreated datePublished" datetime="2020-04-22T17:09:53+08:00">2020-04-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><p>本次文章记录一下使用python3.7+Django2.0.4配合vue.js2.0实现又拍云(upyun.com)存储的异步拖拽文件上传功能。 </p>
<p>首先注册又拍云 upyun.cm</p>
<p>其后在云存储服务中点选，新建一个云空间服务</p>
<img src="/2020/04/22/python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E5%AE%9E%E7%8E%B0%E5%8F%88%E6%8B%8D%E4%BA%91-upyun-com-%E5%AD%98%E5%82%A8%E7%9A%84%E5%BC%82%E6%AD%A5%E6%8B%96%E6%8B%BD%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD/20200321080307_31537.png" class>  

<p>记录一下服务名称，如果手里有备案域名的话，可以分一个二级域名出来绑定一下加速域名</p>
<p>随后点击配置-》存储管理，新建一个操作员，这里新建的时候会分配给你一个用户名和密码，其中密码只能系统生成，这里一定要保存好。</p>
<img src="/2020/04/22/python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E5%AE%9E%E7%8E%B0%E5%8F%88%E6%8B%8D%E4%BA%91-upyun-com-%E5%AD%98%E5%82%A8%E7%9A%84%E5%BC%82%E6%AD%A5%E6%8B%96%E6%8B%BD%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD/20200321090352_28544.png" class>  

<p>ok，现在又拍云的云存储服务已经配置好。</p>
<p>我们现在新建一个upload.vue用来配置上传页面</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag"><<span class="name">script</span>></span></span><br><span class="line">	</span><br><span class="line"><span class="javascript">	<span class="keyword">export</span> <span class="keyword">default</span>{</span></span><br><span class="line"></span><br><span class="line">		data(){</span><br><span class="line"></span><br><span class="line"><span class="actionscript">			<span class="keyword">return</span>{</span></span><br><span class="line"></span><br><span class="line">			}</span><br><span class="line">		},</span><br><span class="line"><span class="actionscript">		<span class="comment">//监听属性</span></span></span><br><span class="line">		watch:{</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		},</span><br><span class="line"><span class="actionscript">		<span class="comment">//计算属性</span></span></span><br><span class="line">		computed:{</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		},</span><br><span class="line">		mounted () {</span><br><span class="line"><span class="javascript">			<span class="keyword">let</span> upload = <span class="built_in">document</span>.querySelector(<span class="string">'.upload'</span>);</span></span><br><span class="line"><span class="actionscript">    upload.addEventListener(<span class="string">'dragenter'</span>, <span class="keyword">this</span>.onDrag, <span class="literal">false</span>);</span></span><br><span class="line"><span class="actionscript">    upload.addEventListener(<span class="string">'dragover'</span>, <span class="keyword">this</span>.onDrag, <span class="literal">false</span>);</span></span><br><span class="line"><span class="actionscript">    upload.addEventListener(<span class="string">'drop'</span>, <span class="keyword">this</span>.onDrop, <span class="literal">false</span>);</span></span><br><span class="line">		},</span><br><span class="line"><span class="actionscript">		<span class="comment">//自定义方法</span></span></span><br><span class="line">		methods:{</span><br><span class="line"></span><br><span class="line">			onDrag (e) {</span><br><span class="line">      e.stopPropagation();</span><br><span class="line">      e.preventDefault();</span><br><span class="line">    },</span><br><span class="line">    onDrop (e) {</span><br><span class="line">      e.stopPropagation();</span><br><span class="line">      e.preventDefault();</span><br><span class="line"><span class="actionscript">      <span class="keyword">this</span>.upload_upyun(e.dataTransfer.files);</span></span><br><span class="line">    },</span><br><span class="line"><span class="actionscript">			<span class="comment">//上传又拍云</span></span></span><br><span class="line"><span class="actionscript">			upload_upyun:<span class="function"><span class="keyword">function</span><span class="params">(files)</span></span>{</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="actionscript">				<span class="comment">//获取文件对象</span></span></span><br><span class="line"><span class="actionscript">				<span class="comment">//let file = e.target.files[0];</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> file = files[<span class="number">0</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">				<span class="comment">//声明参数</span></span></span><br><span class="line"><span class="javascript">				<span class="keyword">let</span> param = <span class="keyword">new</span> FormData();</span></span><br><span class="line"><span class="actionscript">				param.append(<span class="string">'file'</span>,file);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">				<span class="keyword">const</span> config = {</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">				headers: { <span class="string">'Content-Type'</span>: <span class="string">'multipart/form-data'</span> }</span></span><br><span class="line"></span><br><span class="line">				} </span><br><span class="line"></span><br><span class="line"><span class="actionscript">				<span class="keyword">this</span>.axios.post(<span class="string">'http://localhost:8000/uploadfile/'</span>, param, config)<span class="comment">// 上传图片</span></span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">				.then(<span class="function"><span class="keyword">function</span><span class="params">(response)</span> </span>{</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">					<span class="built_in">console</span>.log(response)</span></span><br><span class="line"></span><br><span class="line">				});</span><br><span class="line"></span><br><span class="line">						</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">			</span><br><span class="line"></span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"><span class="tag"></<span class="name">script</span>></span></span><br><span class="line"></span><br><span class="line"><span class="tag"><<span class="name">style</span>></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="css"><span class="selector-class">.upload</span> {</span></span><br><span class="line">  margin: 100px auto;</span><br><span class="line">  width: 300px;</span><br><span class="line">  height: 150px;</span><br><span class="line"><span class="css">  <span class="selector-tag">border</span>: 2<span class="selector-tag">px</span> <span class="selector-tag">dashed</span> <span class="selector-id">#f00</span>;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="tag"></<span class="name">style</span>></span></span><br></pre></td></tr></tbody></table></figure>

<p>值得一提的是，vue页面我们使用拖拽上传的方式。</p>
<p>前端页面搞定了，此时我们利用Django做一个上传接口，理论上可以绕过服务端进行上传，但是考虑到安全性，比如签名容易泄露，所以我们采用曲线救国的方式，后台接口虽然中转一下文件，但是并不对文件进行存储，使用chunks的方式分块读取立刻上传又拍云</p>
<p>首先安装又拍云sdk</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install upyun</span><br></pre></td></tr></tbody></table></figure>

<p>然后建立一个视图文件views.py</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> upyun</span><br><span class="line"><span class="comment">#定义文件上传类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadFile</span><span class="params">(View)</span>:</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line"></span><br><span class="line">        img = request.FILES.get(<span class="string">'file'</span>)</span><br><span class="line"></span><br><span class="line">        up = upyun.UpYun(<span class="string">'你的空间名称'</span>, username=<span class="string">'操作员账号'</span>, password=<span class="string">'操作员密码'</span>)</span><br><span class="line"></span><br><span class="line">        headers = { <span class="string">'x-gmkerl-rotate'</span>: <span class="string">'180'</span> }</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> img.chunks():</span><br><span class="line">            res = up.put(<span class="string">'/touxiang1.jpg'</span>, chunk, checksum=<span class="literal">True</span>, headers=headers)</span><br><span class="line"></span><br><span class="line">        <span class="comment">#返回结果</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps({<span class="string">'filename'</span>:img.name}),content_type=<span class="string">'application/json'</span>)</span><br></pre></td></tr></tbody></table></figure>

<img src="/2020/04/22/python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E5%AE%9E%E7%8E%B0%E5%8F%88%E6%8B%8D%E4%BA%91-upyun-com-%E5%AD%98%E5%82%A8%E7%9A%84%E5%BC%82%E6%AD%A5%E6%8B%96%E6%8B%BD%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD/20200321090318_39902.png" class>  

<p>可以看到成功上传，那么如何访问呢，可以通过分配的域名或者自己绑定的域名直接拼接文件地址即可以访问 </p>
<img src="/2020/04/22/python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E5%AE%9E%E7%8E%B0%E5%8F%88%E6%8B%8D%E4%BA%91-upyun-com-%E5%AD%98%E5%82%A8%E7%9A%84%E5%BC%82%E6%AD%A5%E6%8B%96%E6%8B%BD%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD/20200321090347_66412.png" class>  

<p>访问地址：<a href="http://123123123123.test.upcdn.net/%E4%BD%A0%E7%9A%84%E5%9B%BE%E7%89%87.jpg" target="_blank" rel="noopener">http://123123123123.test.upcdn.net/你的图片.jpg</a> </p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/04/06/%E4%BD%BF%E7%94%A8Python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E7%9A%84%E7%BB%84%E4%BB%B6%E9%80%92%E5%BD%92%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%97%A0%E9%99%90%E7%BA%A7%E5%88%86%E7%B1%BB-%E9%80%92%E5%BD%92%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/06/%E4%BD%BF%E7%94%A8Python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E7%9A%84%E7%BB%84%E4%BB%B6%E9%80%92%E5%BD%92%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%97%A0%E9%99%90%E7%BA%A7%E5%88%86%E7%B1%BB-%E9%80%92%E5%BD%92%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84/" class="post-title-link" itemprop="url">使用Python3.7+Django2.0.4配合vue.js2.0的组件递归来实现无限级分类(递归层级结构)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-06 16:43:04" itemprop="dateCreated datePublished" datetime="2020-04-06T16:43:04+08:00">2020-04-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-22 18:20:30" itemprop="dateModified" datetime="2020-04-22T18:20:30+08:00">2020-04-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><p>所谓的无限极分类是啥？其实简单点说就是一个人类可以繁衍出多个后代，然后一个后代又可以分另外多个后代这样无限繁衍下去（可以想象<a href="https://movie.douban.com/subject/26147417/" target="_blank" rel="noopener">神奇动物在哪里2</a>里面莱斯特兰奇的家族族谱），就好象linux系统你可以新建一个文件夹，然后在这个文件夹里又可以建一些个文件夹，在文件夹底下还可以建一些文件夹一样，随后使用tree命令就可以查看文件夹目录层级。</p>
<p>那么这种层级结构也成为树结构在日常的开发需求里也是很常见的，比如美多商城系统的商品分类，课程的目录章节，以及以及论坛里的帖子回复等等，本次我们后台利用Django来写一个能够返回层级结构数据的接口，接口将该数据以json的形式返回前端，前端使用vue的组件递归来展示数据。</p>
<p>首先，打开django项目中的models.py，新建一个类别的模型类，这里我们以最简单的parentid的形式来建立</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cate</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#主键 通过参数声明主键</span></span><br><span class="line">    id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    <span class="comment">#分类名称</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">500</span>)</span><br><span class="line">    <span class="comment">#父级id</span></span><br><span class="line">    pid = models.IntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#表名</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'cate'</span></span><br></pre></td></tr></tbody></table></figure>

<p>由于我们的项目基于drf框架，所以要增加一个序列器类，如果你的项目没有用drf，可以直接用json模块来进行序列化 </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> myapp.models <span class="keyword">import</span> Cate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CateSer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Cate</span><br><span class="line">        fields = <span class="string">"__all__"</span></span><br></pre></td></tr></tbody></table></figure>

<p>由于django序列化出来的类不具备层级结构，所以我们提前写好一个用来递归的方法： </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xTree</span><span class="params">(datas)</span>:</span></span><br><span class="line">    lists=[]</span><br><span class="line">    tree={}</span><br><span class="line">    parent_id=<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> datas:</span><br><span class="line">        item=i</span><br><span class="line">        tree[item[<span class="string">'id'</span>]]=item</span><br><span class="line">    root=<span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> datas:</span><br><span class="line">        obj=i</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> obj[<span class="string">'pid'</span>]:</span><br><span class="line">            root=tree[obj[<span class="string">'id'</span>]]</span><br><span class="line">            lists.append(root)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            parent_id=obj[<span class="string">'pid'</span>]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'childlist'</span> <span class="keyword">not</span> <span class="keyword">in</span> tree[parent_id]:   </span><br><span class="line">                tree[parent_id][<span class="string">'childlist'</span>]=[]</span><br><span class="line">            tree[parent_id][<span class="string">'childlist'</span>].append(tree[obj[<span class="string">'id'</span>]])</span><br><span class="line">    <span class="keyword">return</span> lists</span><br></pre></td></tr></tbody></table></figure>

<p>此时我们写一个视图接口，用来从数据库中读取数据 </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTree</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">#获取订单列表</span></span><br><span class="line">        catelist = Cate.objects.filter()</span><br><span class="line">        <span class="comment">#序列化</span></span><br><span class="line">        catelist_ser = CateSer(catelist,many=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        mylist= xTree(catelist_ser.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(mylist)</span><br></pre></td></tr></tbody></table></figure>

<p> 请在mysql库里存一些测试数据 </p>
<img src="/2020/04/06/%E4%BD%BF%E7%94%A8Python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E7%9A%84%E7%BB%84%E4%BB%B6%E9%80%92%E5%BD%92%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%97%A0%E9%99%90%E7%BA%A7%E5%88%86%E7%B1%BB-%E9%80%92%E5%BD%92%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84/20200303114306_78562.png" class>  

<p> 测试一下接口，看看是否以json的形式返回了层级结构 </p>
<img src="/2020/04/06/%E4%BD%BF%E7%94%A8Python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E7%9A%84%E7%BB%84%E4%BB%B6%E9%80%92%E5%BD%92%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%97%A0%E9%99%90%E7%BA%A7%E5%88%86%E7%B1%BB-%E9%80%92%E5%BD%92%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84/20200303114400_23346.png" class>  

<p>ok,接口没有问题，现在我们把目光投向前端，打开vue项目，新建一个Reply.vue组件</p>
<p>所谓递归组件: 就是组件可以在它们自己的模板中调用自身，不过它们只能通过 name 选项来做这件事，例如给组件设置属性 name: ‘Reply’，然后在模板中就可以使用 Reply 调用自己进行递归调用了</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag"><<span class="name">template</span>></span></span><br><span class="line"></span><br><span class="line">    <span class="tag"><<span class="name">div</span>></span></span><br><span class="line"></span><br><span class="line">        <span class="tag"><<span class="name">li</span> ></span></span><br><span class="line">            <span class="tag"><<span class="name">div</span> <span class="attr">:class</span>=<span class="string">"[data.id==0 ? 'root': '', 'reply']"</span>></span>{{ data.name }}<span class="tag"></<span class="name">div</span>></span></span><br><span class="line">            </span><br><span class="line">            <span class="tag"><<span class="name">ul</span> <span class="attr">v-if</span>=<span class="string">"data.childlist && data.childlist.length>0"</span>></span></span><br><span class="line">                <span class="tag"><<span class="name">Reply</span> <span class="attr">v-for</span>=<span class="string">"child in data.childlist"</span> <span class="attr">:key</span>=<span class="string">"child.id"</span> <span class="attr">:data</span>=<span class="string">"child"</span>/></span></span><br><span class="line">            <span class="tag"></<span class="name">ul</span>></span></span><br><span class="line">        <span class="tag"></<span class="name">li</span>></span></span><br><span class="line"></span><br><span class="line">    <span class="tag"></<span class="name">div</span>></span></span><br><span class="line"><span class="tag"></<span class="name">template</span>></span></span><br><span class="line">    </span><br><span class="line"><span class="tag"><<span class="name">script</span>></span></span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> {</span></span><br><span class="line"><span class="actionscript">        name: <span class="string">'Reply'</span>, <span class="comment">// 递归组件需要设置 name 属性，才能在模板中调用自己</span></span></span><br><span class="line"><span class="actionscript">        props:[<span class="string">'data'</span>],</span></span><br><span class="line">    };</span><br><span class="line"><span class="tag"></<span class="name">script</span>></span></span><br><span class="line">    </span><br><span class="line"><span class="tag"><<span class="name">style</span> ></span></span><br><span class="line"><span class="css">    <span class="selector-class">.reply</span> {</span></span><br><span class="line">        padding-left: 4px;</span><br><span class="line"><span class="css">        <span class="selector-tag">border-left</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#eee</span>;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ul {</span><br><span class="line">            padding-left: 20px;</span><br><span class="line">            list-style: none;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-class">.root</span> { <span class="attribute">display</span>: none; }</span></span><br><span class="line"></span><br><span class="line"><span class="tag"></<span class="name">style</span>></span></span><br></pre></td></tr></tbody></table></figure>

<p>  然后在其他任意组件中调用该Reply.vue组件，传入刚刚写好的接口数据 </p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag"><<span class="name">template</span>></span></span><br><span class="line">    <span class="tag"><<span class="name">div</span>></span></span><br><span class="line">                </span><br><span class="line">        <span class="tag"><<span class="name">Reply</span> <span class="attr">:data</span>=<span class="string">"data"</span> /></span></span><br><span class="line">    </span><br><span class="line">    <span class="tag"></<span class="name">div</span>></span></span><br><span class="line"><span class="tag"></<span class="name">template</span>></span></span><br><span class="line">       </span><br><span class="line"><span class="tag"><<span class="name">script</span>></span></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> {config,formatXml} <span class="keyword">from</span> <span class="string">'../config.js'</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> mh_test <span class="keyword">from</span> <span class="string">'./mh_test.vue'</span>;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> Reply <span class="keyword">from</span> <span class="string">'./Reply.vue'</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">import</span> md5 <span class="keyword">from</span> <span class="string">'js-md5'</span>;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="javascript">    <span class="keyword">export</span> <span class="keyword">default</span> {</span></span><br><span class="line">        data () {</span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> {</span></span><br><span class="line">                data:{},</span><br><span class="line">                online: 0</span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        components: {</span><br><span class="line"><span class="actionscript">            <span class="comment">//'mh_test':mh_test</span></span></span><br><span class="line">            Reply</span><br><span class="line">        },</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">//钩子方法</span></span></span><br><span class="line"><span class="actionscript">        mounted:<span class="function"><span class="keyword">function</span><span class="params">()</span></span>{</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">            <span class="keyword">this</span>.get_token();</span></span><br><span class="line">        },</span><br><span class="line"><span class="actionscript">        <span class="comment">//绑定事件</span></span></span><br><span class="line">        methods:{</span><br><span class="line"></span><br><span class="line">            get_token(){</span><br><span class="line"></span><br><span class="line"><span class="javascript">                <span class="keyword">this</span>.axios.get(<span class="string">'http://localhost:8000/mytree/'</span>).then(<span class="function">(<span class="params">result</span>) =></span>{</span></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(result);</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">var</span> mytree = {<span class="string">'id'</span>:<span class="number">0</span>,name:<span class="string">'123'</span>};</span></span><br><span class="line"><span class="actionscript">                    mytree[<span class="string">'childlist'</span>] = result.data;</span></span><br><span class="line"><span class="actionscript">                    <span class="keyword">this</span>.data = mytree;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="javascript">                    <span class="built_in">console</span>.log(<span class="keyword">this</span>.data);</span></span><br><span class="line"></span><br><span class="line">                });</span><br><span class="line"></span><br><span class="line">            },</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="tag"></<span class="name">script</span>></span></span><br><span class="line"></span><br><span class="line"><span class="tag"><<span class="name">style</span>></span></span><br><span class="line"></span><br><span class="line"><span class="css">    <span class="selector-class">.on</span> {</span></span><br><span class="line"><span class="css">        <span class="selector-tag">background</span>: <span class="selector-id">#cdcbff</span>;</span></span><br><span class="line">    }</span><br><span class="line"><span class="css">    <span class="selector-class">.off</span> {</span></span><br><span class="line"><span class="css">        <span class="selector-tag">background</span>: <span class="selector-id">#fefdff</span>;</span></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line"><span class="tag"></<span class="name">style</span>></span></span><br></pre></td></tr></tbody></table></figure>



<p>最后请求页面，可以看到展示的效果： </p>
<img src="/2020/04/06/%E4%BD%BF%E7%94%A8Python3-7-Django2-0-4%E9%85%8D%E5%90%88vue-js2-0%E7%9A%84%E7%BB%84%E4%BB%B6%E9%80%92%E5%BD%92%E6%9D%A5%E5%AE%9E%E7%8E%B0%E6%97%A0%E9%99%90%E7%BA%A7%E5%88%86%E7%B1%BB-%E9%80%92%E5%BD%92%E5%B1%82%E7%BA%A7%E7%BB%93%E6%9E%84/20200303114749_87796.png" class>  

<p>当然了，vue组件也可以间接的调用自己实现递归，这涉及到组件之间的循环引用，这样比较麻烦，可读性也间接的降低了不少。 </p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/04/02/%E4%BD%BF%E7%94%A8python3-7-Vue-js2-0-Django2-0-4%E5%BC%82%E6%AD%A5%E5%89%8D%E7%AB%AF%E9%80%9A%E8%BF%87api%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%B0%E4%B8%83%E7%89%9B%E4%BA%91%E4%BA%91%E7%AB%AF%E5%AD%98%E5%82%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/02/%E4%BD%BF%E7%94%A8python3-7-Vue-js2-0-Django2-0-4%E5%BC%82%E6%AD%A5%E5%89%8D%E7%AB%AF%E9%80%9A%E8%BF%87api%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%B0%E4%B8%83%E7%89%9B%E4%BA%91%E4%BA%91%E7%AB%AF%E5%AD%98%E5%82%A8/" class="post-title-link" itemprop="url">使用python3.7+Vue.js2.0+Django2.0.4异步前端通过api上传文件到七牛云云端存储</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-02 16:25:44" itemprop="dateCreated datePublished" datetime="2020-04-02T16:25:44+08:00">2020-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-22 18:05:46" itemprop="dateModified" datetime="2020-04-22T18:05:46+08:00">2020-04-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><p>首先注册七牛云：qiniu.com，进入你的七牛云账号，打开秘钥页，记录下你的ak和sk </p>
<img src="/2020/04/02/%E4%BD%BF%E7%94%A8python3-7-Vue-js2-0-Django2-0-4%E5%BC%82%E6%AD%A5%E5%89%8D%E7%AB%AF%E9%80%9A%E8%BF%87api%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%B0%E4%B8%83%E7%89%9B%E4%BA%91%E4%BA%91%E7%AB%AF%E5%AD%98%E5%82%A8/20191215131202_22383.png" class>  

<p>随后新建一个云存储空间，这里空间名字一定要记录一下： </p>
<img src="/2020/04/02/%E4%BD%BF%E7%94%A8python3-7-Vue-js2-0-Django2-0-4%E5%BC%82%E6%AD%A5%E5%89%8D%E7%AB%AF%E9%80%9A%E8%BF%87api%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%B0%E4%B8%83%E7%89%9B%E4%BA%91%E4%BA%91%E7%AB%AF%E5%AD%98%E5%82%A8/20191215131239_52781.png" class>  

<p>此时我们用django写一个获取uptoken的接口，使用drf框架来写，注意别忘了安装七牛云扩展 pip install qiniu </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#七牛云token</span></span><br><span class="line"><span class="keyword">from</span> qiniu <span class="keyword">import</span> Auth</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QiNiu</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        q = Auth(<span class="string">'E2IZM3koC1GR1DUqJHactmixzdyZZhx0edBKqDsk'</span>,<span class="string">'GDnMkvRoE_kFhCSuvdqQj0VcNsRDOHzYJJ_bVd0_'</span>)</span><br><span class="line">        token = q.upload_token(<span class="string">'redinnovation'</span>)</span><br><span class="line">        print(token)</span><br><span class="line">        res = {}</span><br><span class="line">        res[<span class="string">'uptoken'</span>] = token</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(res)</span><br></pre></td></tr></tbody></table></figure>

<p>之后启动django服务：python3 manage.py runserver</p>
<p>访问django服务，确保每一次都会生成新的token,访问<a href="http://localhost:8000/uptoken/" target="_blank" rel="noopener">http://localhost:8000/uptoken/</a></p>
<img src="/2020/04/02/%E4%BD%BF%E7%94%A8python3-7-Vue-js2-0-Django2-0-4%E5%BC%82%E6%AD%A5%E5%89%8D%E7%AB%AF%E9%80%9A%E8%BF%87api%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%B0%E4%B8%83%E7%89%9B%E4%BA%91%E4%BA%91%E7%AB%AF%E5%AD%98%E5%82%A8/20200224074610_64132.png" class>  

<p>接口已经调试好，回到vue.js页面，添加一个上传控件 </p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">{{ imgLoadPercent }}</span><br><span class="line"></span><br><span class="line"> <span class="tag"><<span class="name">input</span> @<span class="attr">change</span>=<span class="string">"uploadInputchange"</span>  <span class="attr">id</span>=<span class="string">"uploadFileInput"</span> <span class="attr">type</span>=<span class="string">"file"</span> ></span></span><br></pre></td></tr></tbody></table></figure>

<p>  这里的imgLoadPercent是上传进度的展示 </p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">data () {</span><br><span class="line">      return {</span><br><span class="line">          uptoken:'',</span><br><span class="line">        imgLoadPercent:'',</span><br><span class="line">}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



<p> 然后在methods里添加几个方法： </p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">get_token(){</span><br><span class="line"></span><br><span class="line">         this.axios.get('http://localhost:8000/uptoken/').then((result) =>{</span><br><span class="line">        console.log(result);</span><br><span class="line">        this.uptoken = result.data.uptoken;</span><br><span class="line">        });</span><br><span class="line">        },</span><br><span class="line">    //触发input change事件</span><br><span class="line">    uploadInputchange(){</span><br><span class="line">        let file = document.getElementById("uploadFileInput").files[0];   //选择的图片文件</span><br><span class="line">        this.get_token();</span><br><span class="line">        this.uploadImgToQiniu(file);</span><br><span class="line">    },</span><br><span class="line">    //上传图片到七牛</span><br><span class="line">    uploadImgToQiniu(file){</span><br><span class="line"></span><br><span class="line">        console.log(this.uptoken);</span><br><span class="line"></span><br><span class="line">        const axiosInstance = this.axios.create({withCredentials: false});    //withCredentials 禁止携带cookie，带cookie在七牛上有可能出现跨域问题</span><br><span class="line">        let data = new FormData();</span><br><span class="line">        data.append('token',this.uptoken);     //七牛需要的token</span><br><span class="line">        data.append('file', file);</span><br><span class="line">        axiosInstance({</span><br><span class="line">            method: 'POST',</span><br><span class="line">            url: 'http://up-z1.qiniu.com/',  //上传地址，华北的空间是up-z1.qiniu.com</span><br><span class="line">            data: data,</span><br><span class="line">            timeout:30000,      //超时时间，因为图片上传有可能需要很久</span><br><span class="line">            onUploadProgress: (e)=> {</span><br><span class="line">                //imgLoadPercent 是上传进度，可以用来添加进度条</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                var complete = (e.loaded / e.total);</span><br><span class="line"></span><br><span class="line">                if (complete < 1) {</span><br><span class="line">                </span><br><span class="line">                    this.imgLoadPercent = (complete *100).toFixed(2)+ '%';</span><br><span class="line"></span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            },</span><br><span class="line">        }).then(data =>{</span><br><span class="line">           console.log(data);</span><br><span class="line">           this.imgLoadPercent = '100%';</span><br><span class="line">        }).catch(function(err) {</span><br><span class="line">            //上传失败</span><br><span class="line">        });</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>



<p>逻辑就是每一次上传之前，请求一次后台django的接口获取token，需要注意一点，在实际操作中，onUploadProgress这个方法并不能完全的真实展示上传进度，受限于网络或者别的因素导致它会有一定的提前量或者延迟，所以我们在这个方法内做了一个类似安慰剂按钮的效果，就是人为限制它不会变为100%，只有当七牛云返回结果的时候再赋值为100%。</p>
<p>最后，如果上传成功后，七牛云接口会返回文件的key</p>
<img src="/2020/04/02/%E4%BD%BF%E7%94%A8python3-7-Vue-js2-0-Django2-0-4%E5%BC%82%E6%AD%A5%E5%89%8D%E7%AB%AF%E9%80%9A%E8%BF%87api%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E5%88%B0%E4%B8%83%E7%89%9B%E4%BA%91%E4%BA%91%E7%AB%AF%E5%AD%98%E5%82%A8/20200224075423_85752.png" class>  

<p> 通过url即可访问。 </p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/03/23/Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/23/Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" class="post-title-link" itemprop="url">Redis主从复制</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-03-23 15:05:07 / 修改时间：18:47:43" itemprop="dateCreated datePublished" datetime="2020-03-23T15:05:07+08:00">2020-03-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><p>和Mysql主从复制的原因一样，Redis虽然读取写入的速度都特别快，但是也会产生读压力特别大的情况。为了分担读压力，Redis支持主从复制，Redis的主从结构可以采用一主多从或者级联结构，Redis主从复制可以根据是否是全量分为全量同步和增量同步。下图为级联结构。 </p>
<p>注：redis主节点Master挂掉时，运维让从节点Slave接管（redis主从默认无法自动切换，需要运维手动切换） </p>
<img src="/2020/03/23/Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/1080958-20191008142005703-1179773131.png" class>  

<h2 id="全量同步"><a href="#全量同步" class="headerlink" title="全量同步"></a><strong>全量同步</strong></h2><p>Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份。具体步骤如下：</p>
<ol>
<li>从服务器连接主服务器，发送SYNC命令；</li>
<li>主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令； </li>
<li>主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；</li>
<li>从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；  </li>
<li>主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令；  </li>
<li>从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令； </li>
</ol>
<img src="/2020/03/23/Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/907596-20180710175736785-1172070242.png" class>  

<p>完成上面几个步骤后就完成了从服务器数据初始化的所有操作，从服务器此时可以接收来自用户的读请求。 </p>
<h2 id="增量同步"><a href="#增量同步" class="headerlink" title="增量同步"></a><strong>增量同步</strong></h2><ol>
<li>主节点会将那些对自己状态产生修改性影响的指令记录在本地内存buffer中，然后异步将buffer中指令同步到从节点</li>
<li>从节点一边执行同步指令达到主节点状态，一边向主节点反馈自己同步到哪里（偏移量）</li>
<li>当网络状态不好时，从节点无法和主节点进行同步，当网络恢复时需要进行快照同步</li>
</ol>
<h2 id="Redis主从同步策略"><a href="#Redis主从同步策略" class="headerlink" title="Redis主从同步策略"></a><strong>Redis主从同步策略</strong></h2><ol>
<li>主从刚刚连接的时候，进行全量同步；全同步结束后，进行增量同步。</li>
<li>当然，如果有需要，slave 在任何时候都可以发起全量同步。</li>
<li>redis 策略是，无论如何，首先会尝试进行增量同步，如不成功，要求从机进行全量同步。 </li>
</ol>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a><strong>注意点</strong></h2><p>如果多个Slave断线了，需要重启的时候，因为只要Slave启动，就会发送sync请求和主机全量同步，当多个同时出现的时候，可能会导致Master IO剧增宕机。</p>
<h2 id="主从复制的一些特点："><a href="#主从复制的一些特点：" class="headerlink" title="主从复制的一些特点："></a><strong>主从复制的一些特点：</strong></h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 采用异步复制；</span><br><span class="line"><span class="number">2.</span> 一个主redis可以含有多个从redis；</span><br><span class="line"><span class="number">3.</span> 每个从redis可以接收来自其他从redis服务器的连接；</span><br><span class="line"><span class="number">4.</span> 主从复制对于主redis服务器来说是非阻塞的，这意味着当从服务器在进行主从复制同步过程中，</span><br><span class="line">   主redis仍然可以处理外界的访问请求；</span><br><span class="line"><span class="number">5.</span> 主从复制对于从redis服务器来说也是非阻塞的，这意味着，即使从redis在进行主从复制过程中</span><br><span class="line">   也可以接受外界的查询请求，只不过这时候从redis返回的是以前老的数据，</span><br><span class="line">   如果你不想这样，那么在启动redis时，可以在配置文件中进行设置，那么从redis在复制同步过程中</span><br><span class="line">   来自外界的查询请求都会返回错误给客户端；（虽然说主从复制过程中</span><br><span class="line">   对于从redis是非阻塞的，但是当从redis从主redis同步过来最新的数据后还需要将新数据加载到内存中，</span><br><span class="line">   在加载到内存的过程中是阻塞的，在这段时间内的请求将会被阻，</span><br><span class="line">   但是即使对于大数据集，加载到内存的时间也是比较多的）；</span><br><span class="line"><span class="number">6.</span> 主从复制提高了redis服务的扩展性，避免单个redis服务器的读写访问压力过大的问题，同时也可以给为</span><br><span class="line">   数据备份及冗余提供一种解决方案；</span><br><span class="line"><span class="number">7.</span> 为了编码主redis服务器写磁盘压力带来的开销，可以配置让主redis不在将数据持久化到磁盘，而是通过</span><br><span class="line">   连接让一个配置的从redis服务器及时的将相关数据持久化到磁盘，</span><br><span class="line">   不过这样会存在一个问题，就是主redis服务器一旦重启，因为主redis服务器数据为空，这时候通过</span><br><span class="line">   主从同步可能导致从redis服务器上的数据也被清空；</span><br></pre></td></tr></tbody></table></figure>

<h2 id="主从同步中需要注意几个问题"><a href="#主从同步中需要注意几个问题" class="headerlink" title="主从同步中需要注意几个问题"></a><strong>主从同步中需要注意几个问题</strong></h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 在上面的全量同步过程中，master会将数据保存在rdb文件中然后发送给slave服务器，但是如果master上的</span><br><span class="line">   磁盘空间有效怎么办呢？那么此时全部同步对于master来说</span><br><span class="line">   将是一份十分有压力的操作了。此时可以通过无盘复制来达到目的，由master直接开启一个socket将</span><br><span class="line">   rdb文件发送给slave服务器。（无盘复制一般应用在磁盘空间有限但是网络状态良好的情况下）</span><br><span class="line"><span class="number">2.</span> 主从复制结构，一般slave服务器不能进行写操作，但是这不是死的，之所以这样是为了更容易的保证主和各个</span><br><span class="line">   从之间数据的一致性，如果slave服务器上数据进行了修改，</span><br><span class="line">   那么要保证所有主从服务器都能一致，可能在结构上和处理逻辑上更为负责。不过你也可以通过配置文件让</span><br><span class="line">   从服务器支持写操作。（不过所带来的影响还得自己承担哦。。。）</span><br><span class="line"><span class="number">3.</span> 主从服务器之间会定期进行通话，但是如果master上设置了密码，那么如果不给slave设置密码就会导致</span><br><span class="line">   slave不能跟master进行任何操作，所以如果你的master服务器上有密码，那么也给slave相应的设置一下</span><br><span class="line">   密码吧（通过设置配置文件中的masterauth）;</span><br><span class="line"><span class="number">4.</span> 关于slave服务器上过期键的处理，由master服务器负责键的过期删除处理，然后将相关删除命令已数据同步</span><br><span class="line">   的方式同步给slave服务器，slave服务器根据删除命令删除本地的key。</span><br></pre></td></tr></tbody></table></figure>

<h2 id="当主服务器不进行持久化时复制的安全性"><a href="#当主服务器不进行持久化时复制的安全性" class="headerlink" title="当主服务器不进行持久化时复制的安全性"></a><strong>当主服务器不进行持久化时复制的安全性</strong></h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">在进行主从复制设置时，强烈建议在主服务器上开启持久化，当不能这么做时，比如考虑到延迟的问题，</span><br><span class="line">应该将实例配置为避免自动重启。</span><br><span class="line"></span><br><span class="line">为什么不持久化的主服务器自动重启非常危险呢？</span><br><span class="line">为了更好的理解这个问题，看下面这个失败的例子，其中主服务器和从服务器中数据库都被删除了。</span><br><span class="line"></span><br><span class="line">设置节点A为主服务器，关闭持久化，节点B和C从节点A复制数据。</span><br><span class="line">这时出现了一个崩溃，但Redis具有自动重启系统，重启了进程，因为关闭了持久化，节点重启后只有一个空的数据集</span><br><span class="line">节点B和C从节点A进行复制，现在节点A是空的，所以节点B和C上的复制数据也会被删除。</span><br><span class="line">当在高可用系统中使用Redis Sentinel，关闭了主服务器的持久化，并且允许自动重启，这种情况是很危险的。</span><br><span class="line">比如主服务器可能在很短的时间就完成了重启，以至于Sentinel都无法检测到这次失败，那么上面说的这种失败</span><br><span class="line">的情况就发生了。</span><br><span class="line"></span><br><span class="line">如果数据比较重要，并且在使用主从复制时关闭了主服务器持久化功能的场景中，都应该禁止实例自动重启。</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Redis主从复制是如何工作的"><a href="#Redis主从复制是如何工作的" class="headerlink" title="Redis主从复制是如何工作的"></a><strong>Redis主从复制是如何工作的</strong></h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">如果设置了一个从服务器，在连接时它发送了一个SYNC命令，不管它是第一次连接还是再次连接都没有关系。</span><br><span class="line"> </span><br><span class="line">然后主服务器开始后台存储，并且开始缓存新连接进来的修改数据的命令。当后台存储完成后，主服务器把数据文件</span><br><span class="line">发送到从服务器，</span><br><span class="line">从服务器将其保存在磁盘上，然后加载到内存中。然后主服务器把刚才缓存的命令发送到从服务器。这是作为命令流</span><br><span class="line">来完成的，并且</span><br><span class="line">和Redis协议本身格式相同。</span><br><span class="line"> </span><br><span class="line">你可以通过telnet自己尝试一下。在Redis服务器工作时连接到Redis端口，发送SYNC命令，会看到一个批量的传输</span><br><span class="line">并且主服务器接收的每一个命令都会通过telnet会话重新发送一遍。</span><br><span class="line"> </span><br><span class="line">当主从服务器之间的连接由于某些原因断开时，从服务器可以自动进行重连接。当有多个从服务器同时请求同步时，</span><br><span class="line">主服务器只进行一个后台存储。</span><br><span class="line"> </span><br><span class="line">当连接断开又重新连上之后，一般都会进行一个完整的重新同步，但是从Redis2<span class="number">.8</span>开始，只重新同步一部分也可以。</span><br></pre></td></tr></tbody></table></figure>

<h2 id="部分重新同步"><a href="#部分重新同步" class="headerlink" title="部分重新同步"></a>部分重新同步</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">从Redis <span class="number">2.8</span>开始，如果遭遇连接断开，重新连接之后可以从中断处继续进行复制，而不必重新同步。</span><br><span class="line"> </span><br><span class="line">它的工作原理是这样：</span><br><span class="line">主服务器端为复制流维护一个内存缓冲区（<span class="keyword">in</span>-memory backlog）。主从服务器都维护一个复制偏移量</span><br><span class="line">（replication offset）和master run id ，</span><br><span class="line">当连接断开时，从服务器会重新连接上主服务器，然后请求继续复制，假如主从服务器的两个master run id相同，</span><br><span class="line">并且指定的偏移量在内存缓冲区中还有效，复制就会从上次中断的点开始继续。如果其中一个条件不满足，就会进行</span><br><span class="line">完全重新同步（在<span class="number">2.8</span>版本之前就是直接进行完全重新同步）。</span><br><span class="line">因为主运行id不保存在磁盘中，如果从服务器重启了的话就只能进行完全同步了。</span><br><span class="line"> </span><br><span class="line">部分重新同步这个新特性内部使用PSYNC命令，旧的实现中使用SYNC命令。Redis2<span class="number">.8</span>版本可以检测出它所连接的</span><br><span class="line">服务器是否支持PSYNC命令，不支持的话使用SYNC命令。</span><br></pre></td></tr></tbody></table></figure>





<h2 id="无磁盘复制"><a href="#无磁盘复制" class="headerlink" title="无磁盘复制"></a>无磁盘复制</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">通常来讲，一个完全重新同步需要在磁盘上创建一个RDB文件，然后加载这个文件以便为从服务器发送数据。</span><br><span class="line"> </span><br><span class="line">如果使用比较低速的磁盘，这种操作会给主服务器带来较大的压力。Redis从<span class="number">2.8</span><span class="number">.18</span>版本开始尝试支持无磁盘的复制。</span><br><span class="line">使用这种设置时，子进程直接将RDB通过网络发送给从服务器，不使用磁盘作为中间存储。</span><br></pre></td></tr></tbody></table></figure>



<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">主从复制的配置十分简单：把下面这行加入到从服务器的配置文件中即可。</span><br><span class="line">slaveof <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span> <span class="number">6379</span></span><br><span class="line"> </span><br><span class="line">当然你需要把其中的<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span> <span class="number">6379</span>替换为你自己的主服务器IP（或者主机名hostname）和端口。另外你可以</span><br><span class="line">调用SLAVEOF命令，</span><br><span class="line">主服务器就会开始与从服务器同步。</span><br><span class="line"> </span><br><span class="line">关于部分重新同步，还有一些针对复制内存缓冲区的优化参数。查看Redis介质中的Redis.conf示例获得更多信息。</span><br><span class="line"> </span><br><span class="line">使用repl-diskless-sync配置参数来启动无磁盘复制。使用repl-diskless-sync-delay 参数来配置传输开始</span><br><span class="line">的延迟时间，以便等待</span><br><span class="line">更多的从服务器连接上来。查看Redis介质中的Redis.conf示例获得更多信息。</span><br></pre></td></tr></tbody></table></figure>

<h2 id="只读从服务器"><a href="#只读从服务器" class="headerlink" title="只读从服务器"></a>只读从服务器</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">从Redis <span class="number">2.6</span>开始，从服务器支持只读模式，并且是默认模式。这个行为是由Redis.conf文件中的</span><br><span class="line">slave-read-only 参数控制的，可以在运行中通过CONFIG SET来启用或者禁用。</span><br><span class="line"> </span><br><span class="line">只读的从服务器会拒绝所有写命令，所以对从服务器不会有误写操作。但这不表示可以把从服务器实例暴露</span><br><span class="line">在危险的网络环境下，</span><br><span class="line">因为像DEBUG或者CONFIG这样的管理命令还是可以运行的。不过你可以通过使用rename-command命令</span><br><span class="line">来为这些命令改名来增加安全性。</span><br><span class="line"> </span><br><span class="line">你可能想知道为什么只读限制还可以被还原，使得从服务器还可以进行写操作。虽然当主从服务器进行</span><br><span class="line">重新同步或者从服务器重启后，</span><br><span class="line">这些写操作都会失效，还是有一些使用场景会想从服务器中写入临时数据的，但将来这个特性可能会被去掉。</span><br></pre></td></tr></tbody></table></figure>

<h2 id="限制有N个以上从服务器才允许写入"><a href="#限制有N个以上从服务器才允许写入" class="headerlink" title="限制有N个以上从服务器才允许写入"></a>限制有N个以上从服务器才允许写入</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">从Redis <span class="number">2.8</span>版本开始，可以配置主服务器连接N个以上从服务器才允许对主服务器进行写操作。</span><br><span class="line">但是，因为Redis使用的是异步主从复制，</span><br><span class="line">没办法确保从服务器确实收到了要写入的数据，所以还是有一定的数据丢失的可能性。</span><br><span class="line"> </span><br><span class="line">这一特性的工作原理如下：</span><br><span class="line"><span class="number">1</span>）从服务器每秒钟ping一次主服务器，确认处理的复制流数量。</span><br><span class="line"><span class="number">2</span>）主服务器记住每个从服务器最近一次ping的时间。</span><br><span class="line"><span class="number">3</span>）用户可以配置最少要有N个服务器有小于M秒的确认延迟。</span><br><span class="line"><span class="number">4</span>）如果有N个以上从服务器，并且确认延迟小于M秒，主服务器接受写操作。</span><br><span class="line"> </span><br><span class="line">还可以把这看做是CAP原则（一致性，可用性，分区容错性）不严格的一致性实现，虽然不能</span><br><span class="line">百分百确保一致性，但至少保证了丢失的数据不会超过M秒内的数据量。</span><br><span class="line"> </span><br><span class="line">如果条件不满足，主服务器会拒绝写操作并返回一个错误。</span><br><span class="line"><span class="number">1</span>）min-slaves-to-write（最小从服务器数）</span><br><span class="line"><span class="number">2</span>）min-slaves-max-lag（从服务器最大确认延迟）</span><br></pre></td></tr></tbody></table></figure>

</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/03/18/Redis%E6%8C%81%E4%B9%85%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/18/Redis%E6%8C%81%E4%B9%85%E5%8C%96/" class="post-title-link" itemprop="url">Redis持久化</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-03-18 14:17:05 / 修改时间：21:37:18" itemprop="dateCreated datePublished" datetime="2020-03-18T14:17:05+08:00">2020-03-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index">
                    <span itemprop="name">Redis</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="Redis官网"><a href="#Redis官网" class="headerlink" title="Redis官网"></a>Redis官网</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://redis.io/		<span class="comment">#官方文档</span></span><br><span class="line">http://redis.cn/		<span class="comment">#中文文档</span></span><br></pre></td></tr></tbody></table></figure>





<h2 id="为什么要做持久化存储"><a href="#为什么要做持久化存储" class="headerlink" title="为什么要做持久化存储?"></a>为什么要做持久化存储?</h2><p>持久化存储是将 Redis 存储在内存中的数据存储在硬盘中，实现数据的永久保存。我们都知道 Redis 是一个基于内存的 nosql 数据库，内存存储很容易造成数据的丢失，因为当服务器关机等一些异常情况都会导致存储在内存中的数据丢失。 </p>
<h2 id="持久化存储分类"><a href="#持久化存储分类" class="headerlink" title="持久化存储分类"></a>持久化存储分类</h2><p>在 Redis 中，持久化存储分为两种。一种是 RDB数据快照的方式，另外一种是 AOF日志追加的方式。 </p>
<h2 id="RDB持久化原理"><a href="#RDB持久化原理" class="headerlink" title="RDB持久化原理"></a><strong>RDB持久化原理</strong></h2><ol>
<li>RDB持久化是指在指定的时间间隔内将内存中的数据集快照写入磁盘 　　　　　　　　</li>
<li>实际操作过程是fork一个子进程，先将数据集写入临时文件，写入成功后，再替换之前的文件，用二进制压缩存储 </li>
</ol>
<img src="/2020/03/18/Redis%E6%8C%81%E4%B9%85%E5%8C%96/1080958-20180314095937765-220628310.png" class>

<h2 id="RDB持久化"><a href="#RDB持久化" class="headerlink" title="RDB持久化"></a>RDB持久化</h2><h3 id="1-手动执行指令触发-进行存储"><a href="#1-手动执行指令触发-进行存储" class="headerlink" title="1. 手动执行指令触发, 进行存储"></a>1. 手动执行指令触发, 进行存储</h3><ul>
<li>save　　　　　　这个指令会阻塞redis, 执行完之前不再接收其他处理</li>
<li>bgsave　　　　　这个指令会创建一个子进程去处理持久化存储, 线上使用</li>
</ul>
<h3 id="2-配置conf文件触发自动存储"><a href="#2-配置conf文件触发自动存储" class="headerlink" title="2. 配置conf文件触发自动存储"></a>2. 配置conf文件触发自动存储</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes                    <span class="comment">#后台运行</span></span><br><span class="line">bind <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>                   <span class="comment">#redis绑定地址</span></span><br><span class="line">port <span class="number">6379</span>                        <span class="comment">#端口</span></span><br><span class="line">requirepass redhat                <span class="comment">#redis登录密码</span></span><br><span class="line">logfile /data/<span class="number">6379</span>/redis.log    <span class="comment">#日志文件</span></span><br><span class="line">dir /data/<span class="number">6379</span>                  <span class="comment">#定义持久化文件存储位置</span></span><br><span class="line"></span><br><span class="line">dbfilename  dbmp.rdb            <span class="comment">#rdb持久化文件</span></span><br><span class="line">save <span class="number">900</span> <span class="number">1</span>                    </span><br><span class="line">save <span class="number">300</span> <span class="number">10</span>                        </span><br><span class="line">save <span class="number">60</span>  <span class="number">10000</span>                   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">save m n   当m秒后, 达到n个存储, 就执行bgsave指令, 进行持久化存储</span><br><span class="line"></span><br><span class="line">其他可选配置</span><br><span class="line"></span><br><span class="line">stop-writes-on-bgsave-error yes　　<span class="comment"># 当bgsave出现错误时，Redis是否停止执行写命令；设置为yes，则当硬盘出现问题时，可以及时发现，避免数据的大量丢失；设置为no，则Redis无视bgsave的错误继续执行写命令，当对Redis服务器的系统(尤其是硬盘)使用了监控时，该选项考虑设置为no</span></span><br><span class="line"></span><br><span class="line">rdbcompression yes　　<span class="comment"># 是否开启RDB文件压缩</span></span><br><span class="line"></span><br><span class="line">rdbchecksum yes　　　　<span class="comment"># 是否开启RDB文件的校验，在写入文件和读取文件时都起作用；关闭checksum在写入文件和启动文件时大约能带来10%的性能提升，但是数据损坏时无法发现</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="AOF持久化原理"><a href="#AOF持久化原理" class="headerlink" title="AOF持久化原理"></a><strong>AOF持久化原理</strong></h2><p>AOF持久化以日志的形式记录服务器所处理的每一个写、删除操作，查询操作不会记录，以文本的方式记录，可以打开文件看到详细的操作记录。 </p>
<img src="/2020/03/18/Redis%E6%8C%81%E4%B9%85%E5%8C%96/1080958-20180314100424696-1890061620.png" class>

<h2 id="AOF持久化"><a href="#AOF持久化" class="headerlink" title="AOF持久化"></a><strong>AOF持久化</strong></h2><h2 id="1-触发配置"><a href="#1-触发配置" class="headerlink" title="1. 触发配置"></a>1. 触发配置</h2><ul>
<li>Redis服务默认开启RDB, 关闭AOF; 开启AOF只在配置文件中加入 appendonly yes</li>
<li>启动Redis服务时会优先加载AOF</li>
</ul>
<h2 id="2-AOF的常见配置"><a href="#2-AOF的常见配置" class="headerlink" title="2. AOF的常见配置"></a>2. AOF的常见配置</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">appendonly no        <span class="comment"># 是否开启AOF</span></span><br><span class="line"></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span>    <span class="comment"># AOF文件名</span></span><br><span class="line"></span><br><span class="line">dir /data/<span class="number">6379</span>                  <span class="comment"># 定义持久化文件存储位置</span></span><br><span class="line"></span><br><span class="line">appendfsync everysec    <span class="comment"># 持久化策略,每秒都存, always总是</span></span><br><span class="line"></span><br><span class="line">no-appendfsync-on-rewrite no     <span class="comment"># AOF重写期间是否禁止fsync；如果开启该选项，可以减轻文件重写时CPU和硬盘的负载（尤其是硬盘），但是可能会丢失AOF重写期间的数据；需要在负载和安全性之间进行平衡</span></span><br><span class="line"></span><br><span class="line">auto-aof-rewrite-percentage <span class="number">100</span>    <span class="comment"># 执行AOF重写时，当前AOF大小(即aof_current_size)和上一次重写时AOF大小(aof_base_size)的比值。</span></span><br><span class="line"></span><br><span class="line">auto-aof-rewrite-min-size <span class="number">64</span>mb     <span class="comment"># 执行AOF重写时，文件的最小体积，默认值为64MB。</span></span><br><span class="line"></span><br><span class="line">aof-load-truncated yes    <span class="comment"># 如果AOF文件结尾损坏，Redis启动时是否仍载入AOF文件</span></span><br></pre></td></tr></tbody></table></figure>



<h2 id="RDB优缺点介绍"><a href="#RDB优缺点介绍" class="headerlink" title="RDB优缺点介绍"></a><strong>RDB优缺点介绍</strong></h2><h3 id="1-RDB优点"><a href="#1-RDB优点" class="headerlink" title="1. RDB优点"></a><strong>1. RDB优点</strong></h3><ol>
<li>整个Redis数据库将只包含一个文件，一旦系统出现灾难性故障，我们可以非常容易的进行恢复。</li>
<li>性能最大化，它仅需要fork出子进程，由子进程完成持久化工作，极大的避免服务进程执行IO操作了。</li>
<li>相比于AOF机制，如果数据集很大，RDB的启动效率会更高</li>
</ol>
<h3 id="2-RDB缺点"><a href="#2-RDB缺点" class="headerlink" title="2. RDB缺点"></a><strong>2. RDB缺点</strong></h3><ol>
<li>RDB容易丢数据，因为系统一旦在定时持久化之前出现宕机现象，此前没有来得及写入磁盘的数据都将丢</li>
<li>RDB通过fork子进程来完成持久化的，如果当数据集较大时，可能会导致整个服务器停止服务几百毫秒，甚至是1秒钟。</li>
</ol>
<h2 id="AOF优缺点介绍"><a href="#AOF优缺点介绍" class="headerlink" title="AOF优缺点介绍"></a><strong>AOF优缺点介绍</strong></h2><h3 id="1-AOF优点"><a href="#1-AOF优点" class="headerlink" title="1. AOF优点"></a><strong>1. AOF优点</strong></h3><ol>
<li>数据安全性高，Redis中提供了3中同步策略，即每秒同步、每修改同步和不同步</li>
<li>由于该机制对日志文件的写入操作采用的是append模式，因此在写入过程中即使出现宕机现象，也不会破坏日志文件中已经存在的内容</li>
<li>如果日志过大，Redis可以自动启用rewrite机制。即Redis以append模式不断的将修改数据写入到老的磁盘文件中</li>
<li>AOF包含一个格式清晰、易于理解的日志文件用于记录所有的修改操作。事实上，我们也可以通过该文件完成数据的重建</li>
</ol>
<h3 id="2-AOF缺点"><a href="#2-AOF缺点" class="headerlink" title="2. AOF缺点"></a><strong>2. AOF缺点</strong></h3><ol>
<li>对于相同数量的数据集而言，AOF文件通常要大于RDB文件，RDB 在恢复大数据集时的速度比 AOF 的恢复速度要快。</li>
<li>AOF在运行效率上往往会慢于RDB</li>
</ol>
<h2 id="选择AOF还是RDB进行数据的持久化"><a href="#选择AOF还是RDB进行数据的持久化" class="headerlink" title="选择AOF还是RDB进行数据的持久化"></a>选择AOF还是RDB进行数据的持久化</h2><ol>
<li>针对不同的情况来选择，建议使用两种方式相结合. </li>
<li>针对数据安全性、完整性要求高的采用aof方式. </li>
<li>针对不太重要的数据可以使用rdb方式. </li>
<li>对于数据进行全量备份，便于数据备份的可以采用rdb方式. </li>
</ol>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/03/10/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/10/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" class="post-title-link" itemprop="url">面向对象</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-10 16:31:02" itemprop="dateCreated datePublished" datetime="2020-03-10T16:31:02+08:00">2020-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-22 15:25:33" itemprop="dateModified" datetime="2020-04-22T15:25:33+08:00">2020-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="面向对象和面向过程的区别"><a href="#面向对象和面向过程的区别" class="headerlink" title="面向对象和面向过程的区别"></a>面向对象和面向过程的区别</h2><p>面向过程是<br>分析出解决问题所需要的步骤，然后用函数把这些步骤一步一步实现，使用的时候一个一个依次调用就可以了<br>面向对象是<br>把构成问题事务分解成各个对象，建立对象的目的不是为了完成一个步骤，而是为了描叙某个事物在整个解决问题的步骤中的行为<br>可以拿生活中的实例来理解面向过程与面向对象，例如五子棋</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">面向过程的设计思路就是：</span><br><span class="line">首先分析问题的步骤：</span><br><span class="line"><span class="number">1</span>、开始游戏，<span class="number">2</span>、黑子先走，<span class="number">3</span>、绘制画面，<span class="number">4</span>、判断输赢，<span class="number">5</span>、轮到白子，<span class="number">6</span>、绘制画面，<span class="number">7</span>、判断输赢，<span class="number">8</span>、返回步骤<span class="number">2</span>，<span class="number">9</span>、输出最后结果、</span><br><span class="line">把上面每个步骤用不同的方法来实现</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">面向对象的设计思路就是：</span><br><span class="line">整个五子棋可以分为<span class="number">1</span>、黑白双方，这两方的行为是一模一样的，<span class="number">2</span>、棋盘系统，负责绘制画面，<span class="number">3</span>、规则系统，负责判定诸如犯规、输赢等</span><br><span class="line">第一类对象（玩家对象）负责接受用户输入，并告知第二类对象（棋盘对象）棋子布局的变化，棋盘对象接收到了棋子的变化就要负责在屏幕上`面显示出这种变化，同时利用第三类对象（规则系统）来对棋局进行判定</span><br></pre></td></tr></tbody></table></figure>

<p>可以明显地看出 面向对象是以功能来划分问题，而不是步骤。同样是绘制棋局，这样的行为在面向过程的设计中分散在了多个步骤中，很可能出现不同的绘制版本，因为通常设计人员会考虑到实际情况进行各种各样的简化。而面向对象的设计中，绘图只可能在棋盘对象中出现，从而保证了绘图的统一 。 </p>
<h3 id="面向过程编程思想："><a href="#面向过程编程思想：" class="headerlink" title="面向过程编程思想："></a>面向过程编程思想：</h3><p>面向过程编程就好比把整个需求的每个过程具体化，流程化。其中优缺点是可见分明的：</p>
<p>优点：可以将复杂的逻辑，经过每个过程后，变的简单明了化。</p>
<p>缺点：可拓展性，维护性等都非常的差。</p>
<p>使用场景一般都是在不经常变动的程序里，比如电脑的操作系统，计算器，Linux內核，git，以及Apache HTTP Server </p>
<h3 id="面向对象编程思想："><a href="#面向对象编程思想：" class="headerlink" title="面向对象编程思想："></a>面向对象编程思想：</h3><p>面向对象编程，说白了就是在对象的基础上来完成需求。换句话说就是可以站在上帝视角来编程，你需要什么对象，就可以创造什么样的对象。让对象与对象之间相互解决。从简单的操作者变成了指挥者。</p>
<p>优点：拓展性，维护性强，效率高。</p>
<p>缺点：使得程序更加的复杂化，不可预知性。</p>
<p>使用场景一般是 用户层，互联网应用，企业内部软件，游戏等 </p>
<h2 id="类和对象"><a href="#类和对象" class="headerlink" title="类和对象"></a><strong>类和对象</strong></h2><h3 id="1-什么是对象？"><a href="#1-什么是对象？" class="headerlink" title="1.什么是对象？"></a>1.什么是对象？</h3><p>对象就是单个存在的事物，并且具有自己特征与行为。也就是特征和相关行为的一个结合体</p>
<h3 id="2-什么是类？"><a href="#2-什么是类？" class="headerlink" title="2.什么是类？"></a>2.什么是类？</h3><p>类其实是人们来抽象定义的一个概念，把有相同行为和相同特征的事物放在一起，并称之为某种类。</p>
<h3 id="3-类与对象的关系"><a href="#3-类与对象的关系" class="headerlink" title="3.类与对象的关系"></a>3.类与对象的关系</h3><p>在现实世界中，是先有对象，再有类的。</p>
<p>而在程序中，你必须先定义一个类来告诉计算机这个对象的特征与行为。</p>
<h2 id="创建类"><a href="#创建类" class="headerlink" title="创建类"></a>创建类</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span><span class="params">(object)</span>:</span>                    <span class="comment">#1、在定义类时继承object就是新式类，没有就是就是旧类式</span></span><br><span class="line">    public_object = <span class="string">"public"</span>           <span class="comment">#2、在类例定义一个公有属性：所有实例都能访问的属性叫“公有属性”</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name,role,weapon,life_value=<span class="number">100</span>,money=<span class="number">15000</span>)</span>:</span>  <span class="comment">#构造函数==初始化方法：模板</span></span><br><span class="line">        self.name = name               <span class="comment">#3、普通属性</span></span><br><span class="line">        self.__heart= <span class="string">"Normal"</span>         <span class="comment">#4、私有属性在外面无法访问</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shot</span><span class="params">(self)</span>:</span>                    <span class="comment">#5、类的方法</span></span><br><span class="line">        print(<span class="string">"%s is shooting..."</span>%self.name)</span><br></pre></td></tr></tbody></table></figure>

<p>在<strong>Python2</strong>中，<strong>基类object</strong>书写与否 会对结果造成很大的影响，这个知识点涉及到<strong>新式类、经典类</strong>的问题 </p>
<p><a href="http://obsessed.top/2018/03/20/python2%E4%B8%8Epython3%E7%9A%84%E5%8C%BA%E5%88%AB/">可以查看另一篇博客</a></p>
<p>详细代码：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span><span class="params">(object)</span>:</span>    <span class="comment">#在定义类时继承object就是新式类，没有就是就是旧类式</span></span><br><span class="line">    public_object = <span class="string">"public"</span>   <span class="comment">#在类例定义一个公有属性：所有实例都能访问的属性叫“公有属性”</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name,role,weapon,life_value=<span class="number">100</span>,money=<span class="number">15000</span>)</span>:</span>  <span class="comment">#构造函数==初始化方法：模板</span></span><br><span class="line">        self.name = name    <span class="comment">#普通属性</span></span><br><span class="line">        self.role = role</span><br><span class="line">        self.weapon = weapon</span><br><span class="line">        self.life_value = life_value</span><br><span class="line">        self.money = money</span><br><span class="line">        self.__heart= <span class="string">"Normal"</span>    <span class="comment">#私有属性在外面无法访问</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shot</span><span class="params">(self)</span>:</span>     <span class="comment">#类的方法</span></span><br><span class="line">        print(<span class="string">"%s is shooting..."</span>%self.name)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">got_shot</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"ah...,I got shot..."</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buy_gun</span><span class="params">(self,gun_name)</span>:</span></span><br><span class="line">        print(<span class="string">"%s just bought %s"</span> %(self.name,gun_name))</span><br><span class="line">        self.weapon = gun_name          <span class="comment">#在购买后让实例值改变</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在下面实例化其实就是传入： Role('r1','Alex','police','AK47') 把r1传给了self</span></span><br><span class="line"><span class="comment">#r1就是实例化后产生的当前Role类的实例，所以self就是实例本身</span></span><br><span class="line"><span class="comment">#我理解r1其实就是__init__函数的内存地址</span></span><br><span class="line"><span class="comment">#所以在下面函数中调用self.name就相当于调用r1.name所以可以调用</span></span><br><span class="line">r1 = Role(<span class="string">'Alex'</span>,<span class="string">'police'</span>,<span class="string">'AK47'</span>) <span class="comment">#生成一个角色  只要一实例化就会自动调用__init__</span></span><br><span class="line">r2 = Role(<span class="string">'Jack'</span>,<span class="string">'terrorist'</span>,<span class="string">'B22'</span>)  <span class="comment">#生成一个角色</span></span><br><span class="line"></span><br><span class="line">r1.shot()</span><br><span class="line">print(r2.weapon)        <span class="comment">#在调用r2.buy_gun('AK47')前是：B22</span></span><br><span class="line">r2.buy_gun(<span class="string">'AK47'</span>)</span><br><span class="line">print(r2.weapon)        <span class="comment">#在调用r2.buy_gun('AK47')后是：AK47</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#私有属性</span></span><br><span class="line"><span class="comment"># print(r2.__heart)     #这里的.__heart是私有属性，所以在外部无法访问</span></span><br><span class="line">print(r2._Role__heart)  <span class="comment">#强制访问私有属性的方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#公有属性</span></span><br><span class="line">print(r2.public_object) <span class="comment">#打印出类的公有属性</span></span><br><span class="line">Role.public_object = <span class="string">'change_public'</span>    <span class="comment">#从全局改变类的公有属性 r1,r2的公有属性都会变</span></span><br><span class="line">print(r2.public_object)  <span class="comment">#这里打印可以看出公有属性变成类“change_public"</span></span><br><span class="line">r2.public_object = <span class="string">"public_r2"</span>          <span class="comment">#改变r2对象的公有属性，r1不会变</span></span><br><span class="line">print(r2.public_object)                  <span class="comment">#打印出改变后的r2公有属性</span></span><br></pre></td></tr></tbody></table></figure>



<h2 id="面向对象三大特性-封装，继承，多态"><a href="#面向对象三大特性-封装，继承，多态" class="headerlink" title="面向对象三大特性: 封装，继承，多态"></a>面向对象三大特性: 封装，继承，多态</h2><h3 id="Encapsulation-封装（隐藏实现细节）"><a href="#Encapsulation-封装（隐藏实现细节）" class="headerlink" title="Encapsulation 封装（隐藏实现细节）"></a><strong>Encapsulation 封装（隐藏实现细节）</strong></h3><ol>
<li>在类中对数据的赋值、内部调用对外部用户是透明的</li>
<li>这使类变成了一个胶囊或容器，里面包含着类的数据和方法</li>
<li>作用：<ul>
<li>防止数据被随意修改 </li>
<li>使外部程序不需要关注对象内部的构造，只需要通过对外提供的接口进行直接访问</li>
</ul>
</li>
</ol>
<h3 id="Inheritance-继承（代码重用）"><a href="#Inheritance-继承（代码重用）" class="headerlink" title="Inheritance 继承（代码重用）"></a><strong>Inheritance 继承（代码重用）</strong></h3><ol>
<li><p>一个类可以派生出子类，在这个父类里定义的属性、方法自动被子类继承 </p>
</li>
<li><p>比如CS中的警察和恐怖分子，可以将两个角色的相同点写到一个父类中，然后同时去继承它 </p>
</li>
<li><p>使用经典类： Person.<strong>init</strong>(self,name,age) 并重写写父类Person的构造方法，实现，先覆盖，再继承，再重构 </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name,age)</span>:</span>  <span class="comment">#执行Person.__init__(self,name,age)时就会将传入的参数执行一遍</span></span><br><span class="line">        self.name = name          <span class="comment">#所以在BlackPerson中不仅有name,age而且还有sex</span></span><br><span class="line">        self.age = age</span><br><span class="line">        self.sex = <span class="string">"normal"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">talk</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"person is talking...."</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WhitePerson</span><span class="params">(Person)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlackPerson</span><span class="params">(Person)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name,age,strength)</span>:</span>     <span class="comment">#先覆盖，再继承，再重构</span></span><br><span class="line">        <span class="comment">#先覆盖父类的__init__方法，再继承父类__init__，再加自己的参数</span></span><br><span class="line">        Person.__init__(self,name,age)        <span class="comment">#先继承父类Person，这里self就是BlackPerson本身</span></span><br><span class="line">        <span class="comment">#先将name,age传给子类BlackPerson,然后调用Person.__init__构造方法将参数出入父类（）</span></span><br><span class="line">        self.strength = strength              <span class="comment">#然后再重构自己的方法,即写自己的参数</span></span><br><span class="line">        print(self.name,self.age,self.sex)</span><br><span class="line">        print(self.strength)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">talk</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"black balabla"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">walk</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"is walking...."</span>)</span><br><span class="line"></span><br><span class="line">b = BlackPerson(<span class="string">"wei er smith"</span>,<span class="number">22</span>,<span class="string">"Strong"</span>)</span><br><span class="line">b.talk()</span><br><span class="line">b.walk()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果：</span></span><br><span class="line"><span class="comment"># wei er smith 22 normal</span></span><br><span class="line"><span class="comment"># Strong</span></span><br><span class="line"><span class="comment"># black balabla</span></span><br><span class="line"><span class="comment"># is walking....</span></span><br><span class="line"><span class="comment"># person is talking....</span></span><br></pre></td></tr></tbody></table></figure>



</li>
</ol>
<h3 id="Polymorphism-多态（接口重用）"><a href="#Polymorphism-多态（接口重用）" class="headerlink" title="Polymorphism 多态（接口重用）"></a><strong>Polymorphism 多态（接口重用）</strong></h3><ol>
<li>多态是面向对象的重要特性,简单点说:“一个接口，多种实现”</li>
<li>指一个基类中派生出了不同的子类，且每个子类在继承同样的方法名的同时又对父类的方法做了不同的实现</li>
<li>这就是同一种事物表现出的多种形态</li>
<li>比如黄种人继承了人talk这个功能，但是他说的是中文，而美国人的talk是英文，但是他们是同样的talk</li>
</ol>
<p>作用：简单的讲就是允许父类调用子类的方法 </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span>    <span class="comment"># Constructor of the class</span></span><br><span class="line">        self.name = name</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">talk</span><span class="params">(self)</span>:</span>              <span class="comment"># Abstract method, defined by convention only</span></span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"Subclass must implement abstract method"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">talk</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Meow!'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(Animal)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">talk</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Woof! Woof!'</span></span><br><span class="line"></span><br><span class="line">animals = [Cat(<span class="string">'Missy'</span>),</span><br><span class="line">           Dog(<span class="string">'Lassie'</span>)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> animal <span class="keyword">in</span> animals:</span><br><span class="line">    print(animal.name + <span class="string">': '</span> + animal.talk())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果：</span></span><br><span class="line"><span class="comment"># Missy: Meow!</span></span><br><span class="line"><span class="comment"># Lassie: Woof! Woof!</span></span><br></pre></td></tr></tbody></table></figure>



<h2 id="静态方法、类方法、属性方法"><a href="#静态方法、类方法、属性方法" class="headerlink" title="静态方法、类方法、属性方法"></a>静态方法、类方法、属性方法</h2><h3 id="静态方法"><a href="#静态方法" class="headerlink" title="静态方法"></a>静态方法</h3><ol>
<li><strong>作用</strong>：静态方法可以更好的组织代码，防止代码变大后变得比较混乱 </li>
<li><strong>特性</strong>:  静态方法只是名义上归类管理，实际上在静态方法里访问不了类或则实例中的任何属性 </li>
<li><strong>静态方法的使用场景</strong><ul>
<li>我们要写一个只在类中运行而不在实例中运行的方法</li>
<li>经常有一些跟类有关系的功能但在运行时又不需要实例和类参与的情况下需要用到静态方法 </li>
<li>比如更改环境变量或者修改其他类的属性等能用到静态方法 </li>
<li>这种情况可以直接用函数解决, 但这样同样会扩散类内部的代码，造成维护困难</li>
</ul>
</li>
<li><strong>调用方式:</strong>  既可以被类直接调用，也可以通过实例调用 </li>
</ol>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">()</span>:</span></span><br><span class="line">        print(<span class="string">"I am a static method"</span>)</span><br><span class="line">d = Dog(<span class="string">"ChenRonghua"</span>)</span><br><span class="line">d.eat()                       	<span class="comment">#方法1：使用实例调用</span></span><br><span class="line">Dog.eat()                   	<span class="comment">#方法2：使用类直接调用</span></span><br></pre></td></tr></tbody></table></figure>



<h3 id="类方法"><a href="#类方法" class="headerlink" title="类方法"></a><strong>类方法</strong></h3><ol>
<li><strong>作用</strong>：无需实例化直接被类调用  </li>
<li><strong>特性:</strong>  类方法只能访问类变量，不能访问实例变量</li>
<li><strong>类方法使用场景：</strong> 当我们还未创建实例，但是需要调用类中的方法</li>
<li><strong>调用方式:</strong>  既可以被类直接调用，也可以通过实例调用</li>
</ol>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(object)</span>:</span></span><br><span class="line">    name = <span class="string">'类变量'</span> <span class="comment">#在这里如果不定义类变量仅定义实例变量依然报错</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name)</span>:</span></span><br><span class="line">        self.name = <span class="string">'实例变量'</span></span><br><span class="line">        self.name = name</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self,food)</span>:</span></span><br><span class="line">        print(<span class="string">"%s is eating %s"</span>%(self.name,food))</span><br><span class="line">Dog.eat(<span class="string">'baozi'</span>)                   <span class="comment">#方法1：使用类直接调用</span></span><br><span class="line">d = Dog(<span class="string">"ChenRonghua"</span>)          </span><br><span class="line">d.eat(<span class="string">"包子"</span>)                      <span class="comment">#方法2：使用实例d调用</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="属性方法"><a href="#属性方法" class="headerlink" title="属性方法"></a>属性方法</h3><p><strong>作用：</strong>属性方法把一个方法变成一个属性，隐藏了实现细节,调用时不必加括号直接d.eat即可调用self.eat()方法 </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">" %s is eating"</span> % self.name)</span><br><span class="line">d = Dog(<span class="string">"ChenRonghua"</span>)</span><br><span class="line">d.eat()</span><br><span class="line"><span class="comment"># 调用会出以下错误， 说NoneType is not callable, 因为eat此时已经变成一个静态属性了， </span></span><br><span class="line"><span class="comment"># 不是方法了， 想调用已经不需要加()号了，直接d.eat就可以了</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="类中的魔法方法"><a href="#类中的魔法方法" class="headerlink" title="类中的魔法方法"></a>类中的魔法方法</h2><ol>
<li><p><code>__new__</code>静态方法，返回一个创建的实例</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'__new__'</span>)</span><br><span class="line">        <span class="keyword">return</span> object.__new__(cls)    <span class="comment"># 必须返回父类的__new__方法，否则不不执行__init__方法，无法创建实例</span></span><br></pre></td></tr></tbody></table></figure>



</li>
</ol>
<ol start="2">
<li><p><code>__init__</code>构造器，当一个实例被创建的时候调用的初始化方法 </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span>:</span> <span class="comment">##封装一个猫类</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,new_name)</span>:</span> <span class="comment"># 属性定义初始化方法  创建对象时就会被调用</span></span><br><span class="line">        print(<span class="string">'这是一个初始化方法'</span>)</span><br><span class="line">        self.name = new_name  <span class="comment">##属性的定义</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eat</span><span class="params">(self)</span>:</span> <span class="comment">## 方法</span></span><br><span class="line">        print(<span class="string">'%s 爱吃鱼'</span> %(self.name))</span><br><span class="line">Tom=Cat(<span class="string">"tom"</span>)</span><br><span class="line">print(Tom.name)</span><br><span class="line">Tom.eat()</span><br><span class="line"><span class="comment"># 运行结果：</span></span><br><span class="line"><span class="comment">#这是一个初始化方法</span></span><br><span class="line"><span class="comment">#tom</span></span><br><span class="line"><span class="comment">#tom 爱吃鱼</span></span><br></pre></td></tr></tbody></table></figure>



</li>
</ol>
<ol start="3">
<li><p><code>__del__</code> 析构器，当一个实例被销毁的时候调用的方法 </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cat</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        print(<span class="string">'%s 来了'</span> %(self.name))</span><br><span class="line">    <span class="function"><span class="keyword">def</span>  <span class="title">__del__</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'%s 走了'</span> %(self.name))</span><br><span class="line">tom = Cat(<span class="string">'tom'</span>)</span><br><span class="line">print(tom.name)</span><br><span class="line"><span class="comment"># del tom</span></span><br><span class="line">print(<span class="string">'*'</span> * <span class="number">50</span>)</span><br><span class="line">print(tom.name)</span><br><span class="line"></span><br><span class="line"><span class="comment">#运行结果：</span></span><br><span class="line"><span class="comment">#tom 来了</span></span><br><span class="line"><span class="comment">#tom</span></span><br><span class="line"><span class="comment">#**************************************************</span></span><br><span class="line"><span class="comment">#tom</span></span><br><span class="line"><span class="comment">#tom 走了</span></span><br></pre></td></tr></tbody></table></figure>



</li>
</ol>
<ol start="4">
<li><p><code>__doc__</code>表示类的描述信息</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">    <span class="string">""" 输出类的描述类信息 """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">print(Foo.__doc__) <span class="comment">#运行结果：描输出类的描述类信息</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>__call__</code>对象后面加括号，触发执行</p>
<p><strong>作用：</strong>构造方法<strong>init</strong>的执行是由创建对象触发的，即：对象 = 类名() ；而对于 <strong>call</strong> 方法的执行是由对象后括号触发的，即：对象() 或者 类()()      执行<strong>call</strong>方法</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,name)</span>:</span></span><br><span class="line">        self.name = <span class="string">'实例变量'</span></span><br><span class="line">        self.name = name</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">"running call"</span>)</span><br><span class="line">        print(args,kwargs)</span><br><span class="line">d = Dog(<span class="string">"ChenRonghua"</span>)</span><br><span class="line">d(name=<span class="string">'tom'</span>)               <span class="comment"># 如果只实例化，而不d()调用，__call__函数不会执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行结果：</span></span><br><span class="line"><span class="comment"># running call</span></span><br><span class="line"><span class="comment"># () {'name': 'tom'}</span></span><br></pre></td></tr></tbody></table></figure>



</li>
</ol>
<ol start="6">
<li><p><code>__str__</code>如果一个类中定义了<code>__str__</code>方法，在打印对象时，默认输出该方法的返回值</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'alex li'</span></span><br><span class="line">obj = Foo()</span><br><span class="line">print(obj)     <span class="comment"># 输出：alex li</span></span><br></pre></td></tr></tbody></table></figure>



</li>
</ol>
<ol start="7">
<li><p><code>__dict__</code> 查看类或对象中的所有成员</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Province</span>:</span></span><br><span class="line">    country = <span class="string">'China'</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, count)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.count = count</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        print(<span class="string">'func'</span>)</span><br><span class="line"><span class="comment"># 获取类的成员，即：静态字段、方法、</span></span><br><span class="line">print(Province.__dict__)</span><br><span class="line"><span class="comment"># 输出：{'country': 'China', '__module__': '__main__', 'func': <function func at 0x10be30f50>, '__init__': <function __init__ at 0x10be30ed8>, '__doc__': None}</span></span><br><span class="line"></span><br><span class="line">obj1 = Province(<span class="string">'HeBei'</span>,<span class="number">10000</span>)</span><br><span class="line">print(obj1.__dict__)</span><br><span class="line"><span class="comment"># 获取 对象obj1 的成员</span></span><br><span class="line"><span class="comment"># 输出：{'count': 10000, 'name': 'HeBei'}</span></span><br><span class="line"></span><br><span class="line">obj2 = Province(<span class="string">'HeNan'</span>, <span class="number">3888</span>)</span><br><span class="line">print(obj2.__dict__)</span><br><span class="line"><span class="comment"># 获取 对象obj1 的成员</span></span><br><span class="line"><span class="comment"># 输出：{'count': 3888, 'name': 'HeNan'}</span></span><br></pre></td></tr></tbody></table></figure>



</li>
</ol>
<ol start="8">
<li><p><code>__getitem__、__setitem__、__delitem__</code></p>
<p><strong>作用：</strong>用于索引操作，如字典。以上分别表示获取、设置、删除数据 </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        print(<span class="string">'__getitem__'</span>, key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self, key, value)</span>:</span></span><br><span class="line">        print(<span class="string">'__setitem__'</span>, key, value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__delitem__</span><span class="params">(self, key)</span>:</span></span><br><span class="line">        print(<span class="string">'__delitem__'</span>, key)</span><br><span class="line"></span><br><span class="line">obj = Foo()</span><br><span class="line">result = obj[<span class="string">'k1'</span>]           <span class="comment"># __getitem__ k1</span></span><br><span class="line">obj[<span class="string">'k2'</span>] = <span class="string">'wupeiqi'</span>        <span class="comment"># __setitem__ k2 wupeiqi</span></span><br><span class="line"><span class="keyword">del</span> obj[<span class="string">'k1'</span>]                <span class="comment"># __delitem__ k1</span></span><br></pre></td></tr></tbody></table></figure>

</li>
</ol>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/03/09/%E8%A3%85%E9%A5%B0%E5%99%A8%E3%80%81%E8%BF%AD%E4%BB%A3%E5%99%A8%E3%80%81%E7%94%9F%E6%88%90%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/09/%E8%A3%85%E9%A5%B0%E5%99%A8%E3%80%81%E8%BF%AD%E4%BB%A3%E5%99%A8%E3%80%81%E7%94%9F%E6%88%90%E5%99%A8/" class="post-title-link" itemprop="url">装饰器、迭代器、生成器</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-03-09 15:18:24 / 修改时间：17:39:28" itemprop="dateCreated datePublished" datetime="2020-03-09T15:18:24+08:00">2020-03-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h2><h3 id="什么是装饰器？"><a href="#什么是装饰器？" class="headerlink" title="什么是装饰器？"></a>什么是装饰器？</h3><ul>
<li>装饰器本质是函数，用来给其他函数添加新的功能</li>
<li>特点：不修改调用方式、不修改源代码</li>
</ul>
<h3 id="装饰器的应用场景"><a href="#装饰器的应用场景" class="headerlink" title="装饰器的应用场景"></a>装饰器的应用场景</h3><ul>
<li>用户认证，判断用户是否登录</li>
<li>计算函数运行时间（算是一个功能、在项目里用的不多）</li>
<li>插入日志的时候</li>
<li>redis缓存</li>
</ul>
<h3 id="装饰器求函数运行时间"><a href="#装饰器求函数运行时间" class="headerlink" title="装饰器求函数运行时间"></a>装饰器求函数运行时间</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timer</span><span class="params">(func)</span>:</span>   <span class="comment">#timer(test1)  func=test1</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">deco</span><span class="params">(*args,**kwargs)</span>:</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        func(*args,**kwargs)      <span class="comment">#run test1</span></span><br><span class="line">        stop_time = time.time()</span><br><span class="line">        print(<span class="string">"running time is %s"</span>%(stop_time-start_time))</span><br><span class="line">    <span class="keyword">return</span> deco</span><br><span class="line"></span><br><span class="line"><span class="meta">@timer     # test1=timer(test1)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test1</span><span class="params">()</span>:</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">"in the test1"</span>)</span><br><span class="line">test1()</span><br></pre></td></tr></tbody></table></figure>



<h3 id="三级装饰器"><a href="#三级装饰器" class="headerlink" title="三级装饰器"></a>三级装饰器</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">auth</span><span class="params">(auth_type)</span>:</span></span><br><span class="line">    print(<span class="string">"auth func:"</span>,auth_type)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">outer_wrapper</span><span class="params">(func)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">            print(<span class="string">"wrapper func args:"</span>, *args, **kwargs)</span><br><span class="line">            print(<span class="string">'运行前'</span>)</span><br><span class="line">            func(*args, **kwargs)</span><br><span class="line">            print(<span class="string">'运行后'</span>)</span><br><span class="line">        <span class="keyword">return</span> wrapper</span><br><span class="line">    <span class="keyword">return</span> outer_wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@auth(auth_type="local") # home = wrapper()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">"welcome to home  page"</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"from home"</span></span><br><span class="line">home()</span><br></pre></td></tr></tbody></table></figure>







<hr>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p><strong>迭代器是访问集合内元素的一种方式</strong>。迭代器对象从集合的第一个元素开始访问，直到所有的元素都被访问一遍后结束。 </p>
<h3 id="迭代器和可迭代对象"><a href="#迭代器和可迭代对象" class="headerlink" title="迭代器和可迭代对象"></a>迭代器和可迭代对象</h3><ol>
<li>凡是可作用于<code>for</code>循环的对象都是可迭代的（Iterable）类型；</li>
<li>凡是可作用于<code>next()</code>函数的对象都是迭代器（<code>Iterator）</code>类型，它们表示一个惰性计算的序列；</li>
<li>集合数据类型如<code>list</code>、<code>dict</code>、<code>str</code>等是可迭代的但不是迭代器，不过可以通过<code>iter()</code>函数获得一个<code>Iterator</code>对象。</li>
<li>Python的<code>for</code>循环本质上就是通过不断调用<code>next()</code>函数实现的</li>
</ol>
<p><strong>总结：</strong> 一个实现了<strong>iter</strong>方法的对象是可迭代的，一个实现next方法的对象是迭代器</p>
<h3 id="迭代器的两种方法"><a href="#迭代器的两种方法" class="headerlink" title="迭代器的两种方法"></a>迭代器的两种方法</h3><ol>
<li><p><strong>__iter__方法</strong></p>
<p>​    返回迭代器自身 </p>
</li>
<li><p><strong>next方法</strong></p>
<p>​    返回容器的下一个元素 </p>
</li>
</ol>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = iter([<span class="number">1</span>,<span class="number">2</span>])              <span class="comment">#生成一个迭代器</span></span><br><span class="line">print(a.__next__())</span><br><span class="line">print(a.__next__())</span><br><span class="line">print(a.__next__())           <span class="comment">#在这一步会引发  “StopIteration” 的异常</span></span><br></pre></td></tr></tbody></table></figure>



<p><strong>注意：</strong>如果next方法被调用，但是迭代器中没有值可以返回就会引发一个StopIteration异常 </p>
<h3 id="判断是否是可迭代对象"><a href="#判断是否是可迭代对象" class="headerlink" title="判断是否是可迭代对象"></a>判断是否是可迭代对象</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Iterable</span><br><span class="line">print(isinstance([],Iterable))                               <span class="comment">#True</span></span><br><span class="line">print(isinstance({},Iterable))                               <span class="comment">#True</span></span><br><span class="line">print(isinstance((),Iterable))                               <span class="comment">#True</span></span><br><span class="line">print(isinstance(<span class="string">"aaa"</span>,Iterable))                            <span class="comment">#True</span></span><br><span class="line">print(isinstance((x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>)),Iterable))           <span class="comment">#True</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="判断是否是迭代器"><a href="#判断是否是迭代器" class="headerlink" title="判断是否是迭代器"></a>判断是否是迭代器</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Iterator</span><br><span class="line">t = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line">print(isinstance(t,Iterator))           <span class="comment">#False</span></span><br><span class="line">t1 = iter(t)</span><br><span class="line">print(isinstance(t1,Iterator))          <span class="comment">#True</span></span><br></pre></td></tr></tbody></table></figure>



<h3 id="使用迭代器生成斐波那契数列"><a href="#使用迭代器生成斐波那契数列" class="headerlink" title="使用迭代器生成斐波那契数列"></a>使用迭代器生成斐波那契数列</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FibIterator</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,n)</span>:</span></span><br><span class="line">        self.n = n</span><br><span class="line">        self.current = <span class="number">0</span></span><br><span class="line">        self.num1 = <span class="number">0</span></span><br><span class="line">        self.num2 = <span class="number">1</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.current < self.n :</span><br><span class="line">            num = self.num1</span><br><span class="line">            self.num1 , self.num2 = self.num2 , self.num1+self.num2</span><br><span class="line">            self.current += <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> num</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">    	<span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    fib = FibIterator(<span class="number">30</span>)</span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> fib:</span><br><span class="line">        print(num,end=<span class="string">' '</span>)</span><br></pre></td></tr></tbody></table></figure>

<hr>
<h2 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h2><h3 id="什么是生成器？"><a href="#什么是生成器？" class="headerlink" title="什么是生成器？"></a>什么是生成器？</h3><ul>
<li>生成器就是一个特殊的迭代器（一边循环，一边计算的机制 ）</li>
<li>一个有yield关键字的函数就是一个生成器<ul>
<li>生成器是这样一个函数，它记住上一次返回时在函数体中的位置。</li>
<li>对生成器函数的第二次（或第 n 次）调用跳转至该函数中间，而上次调用的所有局部变量都保持不变。</li>
</ul>
</li>
</ul>
<h3 id="生成器的应用场景"><a href="#生成器的应用场景" class="headerlink" title="生成器的应用场景"></a>生成器的应用场景</h3><ul>
<li>生成器是一个概念，我们平常写代码可能用的并不多，但是python源码大量使用 </li>
<li>比如我们tornado框架就是基于 生成器+协程 </li>
<li>比如我们要生成一百万个数据，如果用生成器非常节省空间，用列表浪费大量空间 </li>
</ul>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line">t1 = time.time()</span><br><span class="line">g = (i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000000</span>))</span><br><span class="line">t2 = time.time()</span><br><span class="line">lst = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000000</span>)]</span><br><span class="line">t3 = time.time()</span><br><span class="line">print(<span class="string">'生成器时间：'</span>,t2 - t1)  <span class="comment"># 生成器时间： 0.0</span></span><br><span class="line">print(<span class="string">'列表时间：'</span>,t3 - t2)    <span class="comment"># 列表时间： 5.821957349777222</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="为什么使用生成器"><a href="#为什么使用生成器" class="headerlink" title="为什么使用生成器"></a>为什么使用生成器</h3><ul>
<li>节省空间</li>
<li>高效</li>
</ul>
<h3 id="生成器生成斐波那契数列"><a href="#生成器生成斐波那契数列" class="headerlink" title="生成器生成斐波那契数列"></a>生成器生成斐波那契数列</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fei</span><span class="params">(n)</span>:</span></span><br><span class="line">    num1,num2 = <span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    current = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> current < n:</span><br><span class="line">        num = num1</span><br><span class="line">        num1,num2 = num2,num1+num2</span><br><span class="line">        current += <span class="number">1</span></span><br><span class="line">        <span class="keyword">yield</span> num</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    f = fei(<span class="number">10</span>)</span><br><span class="line">    print(f)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            print(next(f))</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></tbody></table></figure>





<h3 id="生成器读取文件"><a href="#生成器读取文件" class="headerlink" title="生成器读取文件"></a>生成器读取文件</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read_big_file_v</span><span class="params">(fname)</span>:</span></span><br><span class="line">    block_size = <span class="number">1024</span> * <span class="number">8</span></span><br><span class="line">    <span class="keyword">with</span> open(fname,encoding=<span class="string">"utf8"</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            chunk = fp.read(block_size)</span><br><span class="line">            <span class="comment"># 当文件没有更多内容时，read 调用将会返回空字符串 ''</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            print(chunk)</span><br><span class="line">            print(<span class="string">'1'</span>)</span><br><span class="line">path = <span class="string">r'E:\python\pachong\story\a.txt'</span></span><br><span class="line">read_big_file_v(path)</span><br></pre></td></tr></tbody></table></figure>



</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/03/09/%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/09/%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E3%80%81%E5%8D%8F%E7%A8%8B/" class="post-title-link" itemprop="url">进程、线程、协程</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-03-09 14:56:41 / 修改时间：17:50:50" itemprop="dateCreated datePublished" datetime="2020-03-09T14:56:41+08:00">2020-03-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><ul>
<li><strong>进程是资源分配的最小单位（ 内存、cpu、网络、io）</strong> </li>
<li><strong>一个运行起来的程序就是一个进程</strong> <ul>
<li>什么是程序（程序是我们存储在硬盘里的代码）</li>
<li>硬盘（256G）、内存条（8G）</li>
<li>当我们双击图标，打开程序的时候，实际上就是通过I/O操作（读写）内存条里面</li>
<li>内存条就是我们所指的资源 </li>
<li>CPU分时<ul>
<li>CPU比你的手速快多了，分时处理每个线程，但是由于太快然你觉得每个线程都是独占cpu</li>
<li>cpu是计算，只有时间片到了，获取cpu，线程真正执行</li>
<li>当你想使用 网络、磁盘等资源的时候，需要cpu的调度</li>
</ul>
</li>
</ul>
</li>
<li>进程具有独立的内存空间，所以没有办法相互通信<ul>
<li>进程如何通信<ul>
<li>进程queue(父子进程通信)</li>
<li>pipe（同一程序下两个进程通信）</li>
<li>managers（同一程序下多个进程通信）</li>
<li>RabbitMQ、redis等（不同程序间通信）</li>
</ul>
</li>
</ul>
</li>
<li>为什么需要进程池<ul>
<li>一次性开启指定数量的进程</li>
<li>如果有十个进程，有一百个任务，一次可以处理多少个（一次性只能处理十个）</li>
<li>防止进程开启数量过多导致服务器压力过大</li>
</ul>
</li>
</ul>
<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><ul>
<li>有了进程为什么还需要线程<ul>
<li>因为进程不能同一时间只能做一个事情</li>
</ul>
</li>
<li>什么是线程<ul>
<li>线程是操作系统调度的最小单位</li>
<li>线程是进程正真的执行者，是一些指令的集合（进程资源的拥有者）</li>
<li>同一个进程下的读多个<strong>线程共享内存空间</strong>，数据直接访问（数据共享）</li>
<li>为了保证数据安全，必须使用<strong>线程锁</strong></li>
</ul>
</li>
<li>GIL全局解释器锁<ul>
<li>在python全局解释器下，保证同一时间只有一个线程运行</li>
<li>防止多个线程都修改数据</li>
</ul>
</li>
<li>线程锁（互斥锁）<ul>
<li>GIL锁只能保证同一时间只能有一个线程对某个资源操作，但当上一个线程还未执行完毕时可能就会释放GIL，其他线程就可以操作了</li>
<li>线程锁本质把线程中的数据加了一把互斥锁<ul>
<li>mysql中共享锁 & 互斥锁</li>
<li>mysql共享锁：共享锁，所有线程都能读，而不能写 </li>
<li>mysql排它锁：排它，任何线程读取这个这个数据的权利都没有 </li>
<li>加上线程锁之后所有其他线程，读都不能读这个数据 </li>
</ul>
</li>
<li>有了GIL全局解释器锁为什么还需要线程锁<ul>
<li>因为cpu是分时使用的</li>
</ul>
</li>
</ul>
</li>
<li>死锁定义<ul>
<li>两个以上的进程或线程在执行过程中，因争夺资源而造成的一种互相等待的现象，若无外力作用，它们都将无法推进下去</li>
</ul>
</li>
</ul>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><ul>
<li>什么是协程<ul>
<li>协程微线程，纤程，本质是一个单线程</li>
<li>协程能在单线程处理高并发<ul>
<li>线程遇到I/O操作会等待、阻塞，协程遇到I/O会自动切换（剩下的只有CPU操作）</li>
<li>线程的状态保存在CPU的寄存器和栈里而协程拥有自己的空间，所以无需上下文切换的开销，所以快</li>
</ul>
</li>
<li>为甚么协程能够遇到I/O自动切换<ul>
<li>协程有一个gevent模块(封装了greenlet模块)，遇到I/O自动切换</li>
</ul>
</li>
</ul>
</li>
<li>协程缺点<ul>
<li>无法利用多核资源：<strong>协程的本质是个单线程,它不能同时将 单个CPU 的多个核用上</strong>,协程需要和进程配合才能运行在多CPU上</li>
<li><strong>线程阻塞（Blocking）操作（如IO时）会阻塞掉整个程序</strong></li>
</ul>
</li>
<li>协程最大的优点<ul>
<li>不仅是处理高并发（单线程下处理高并发）</li>
<li>特别节省资源（500日活，用php写需要两百多态机器，但是golang只需要二十多太机器）</li>
</ul>
</li>
</ul>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/01/08/Dockerfile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/08/Dockerfile/" class="post-title-link" itemprop="url">Dockerfile</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-08 17:51:42" itemprop="dateCreated datePublished" datetime="2020-01-08T17:51:42+08:00">2020-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-22 16:41:32" itemprop="dateModified" datetime="2020-04-22T16:41:32+08:00">2020-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="关于Dockerfile"><a href="#关于Dockerfile" class="headerlink" title="关于Dockerfile"></a>关于Dockerfile</h2><p>　　在Docker中创建镜像最常用的方式，就是使用Dockerfile。Dockerfile是一个Docker镜像的描述文件，我们可以理解成火箭发射的A、B、C、D…的步骤。Dockerfile其内部<strong>包含了一条条的指令</strong>，<strong>每一条指令构建一层，因此每一条指令的内容，就是描述该层应当如何构建</strong>。 </p>
<img src="/2020/01/08/Dockerfile/image1.png" class title="docker">  

<p><strong>一个Dockerfile的实例如下：</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于python3.6的镜像</span></span><br><span class="line">FROM python:<span class="number">3.6</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#维护人的信息</span></span><br><span class="line">MAINTAINER zhangsan</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行的命令</span></span><br><span class="line">RUN  mkdir /code</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置当前工作目录</span></span><br><span class="line">WORKDIR /code</span><br><span class="line"></span><br><span class="line"><span class="comment">#copy文件</span></span><br><span class="line">ADD . /code/</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行的命令</span></span><br><span class="line">RUN pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line"></span><br><span class="line"><span class="comment">#开启8000端口</span></span><br><span class="line">EXPOSE <span class="number">8000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#当启动容器时执行的脚本文件</span></span><br><span class="line">CMD [<span class="string">"python"</span>, <span class="string">"manage.py"</span>, <span class="string">"runserver"</span>, <span class="string">"0:8000"</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><strong>由上可知，Dockerfile结构大致分为四个部分：</strong> </p>
<ol>
<li>基础镜像信息 </li>
<li>维护者信息</li>
<li>镜像操作命令</li>
<li>容器启动时执行指令</li>
</ol>
<img src="/2020/01/08/Dockerfile/image2.png" class title="Dockerfile">  

<hr>
<h2 id="Dockerfile案例"><a href="#Dockerfile案例" class="headerlink" title="Dockerfile案例"></a>Dockerfile案例</h2><p><strong>初始化一个django项目并用docker启动</strong> </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 ~]<span class="comment"># django-admin startproject demo</span></span><br><span class="line">[root@node1 demo]<span class="comment"># cd demo</span></span><br><span class="line">[root@node1 demo]<span class="comment"># python3 manage.py runserver 0.0.0.0:8000                  # 测试项目是否可以启动</span></span><br><span class="line"></span><br><span class="line">[root@node1 demo]<span class="comment"># vim Dockerfile                                            # dockerfile内容如下,路径放到django项目根路径</span></span><br><span class="line">[root@node1 demo]<span class="comment"># vim requirements.txt                                      # django需要安装的包，路径放到django项目根路径</span></span><br><span class="line">[root@node1 demo]<span class="comment"># docker build -t dj_demo:v1 -f Dockerfile . </span></span><br><span class="line">[root@node1 demo]<span class="comment"># docker run -d -p 192.168.56.11:8000:8000 dj_demo:v1</span></span><br></pre></td></tr></tbody></table></figure>

<p><strong>Dockerfile</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM python:<span class="number">3.6</span></span><br><span class="line">MAINTAINER zhangsan</span><br><span class="line">RUN  mkdir /code</span><br><span class="line">WORKDIR /code</span><br><span class="line">ADD . /code/</span><br><span class="line">RUN pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br><span class="line">EXPOSE <span class="number">8000</span></span><br><span class="line">CMD [<span class="string">"python"</span>, <span class="string">"manage.py"</span>, <span class="string">"runserver"</span>, <span class="string">"0:8000"</span>]</span><br></pre></td></tr></tbody></table></figure>

<p><strong>requirements.txt</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Django==<span class="number">2.0</span><span class="number">.4</span></span><br><span class="line">mysqlclient==<span class="number">1.4</span><span class="number">.6</span></span><br></pre></td></tr></tbody></table></figure>

</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://obsessed.top/2020/01/05/docker-compose/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/20160228201627_f5vax.png">
      <meta itemprop="name" content="Ares">
      <meta itemprop="description" content="最重要的是，别放弃希望">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ares">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/05/docker-compose/" class="post-title-link" itemprop="url">docker-compose</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-05 14:18:36" itemprop="dateCreated datePublished" datetime="2020-01-05T14:18:36+08:00">2020-01-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-22 16:41:23" itemprop="dateModified" datetime="2020-04-22T16:41:23+08:00">2020-04-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="docker-compose简介"><a href="#docker-compose简介" class="headerlink" title="docker-compose简介"></a>docker-compose简介</h2><p>Docker-Compose项目是Docker官方的开源项目，负责实现对Docker容器集群的快速编排。</p>
<p>Docker-Compose将所管理的容器分为三层，分别是工程（project），服务（service）以及容器（container）。</p>
<p>Docker-Compose运行目录下的所有文件（docker-compose.yml，extends文件或环境变量文件等）组成一个工程，若无特殊指定工程名即为当前目录名。一个工程当中可包含多个服务，每个服务中定义了容器运行的镜像，参数，依赖。一个服务当中可包括多个容器实例，Docker-Compose并没有解决负载均衡的问题，因此需要借助其它工具实现服务发现及负载均衡。</p>
<p>Docker-Compose的工程配置文件默认为docker-compose.yml，可通过环境变量COMPOSE_FILE或-f参数自定义配置文件，其定义了多个有依赖关系的服务及每个服务运行的容器。</p>
<p>使用一个Dockerfile模板文件，可以让用户很方便的定义一个单独的应用容器。在工作中，经常会碰到需要多个容器相互配合来完成某项任务的情况。例如要实现一个Web项目，除了Web服务容器本身，往往还需要再加上后端的数据库服务容器，甚至还包括负载均衡容器等。</p>
<p>Compose允许用户通过一个单独的docker-compose.yml模板文件（YAML 格式）来定义一组相关联的应用容器为一个项目（project）。</p>
<p>Docker-Compose项目由Python编写，调用Docker服务提供的API来对容器进行管理。因此，只要所操作的平台支持Docker API，就可以在其上利用Compose来进行编排管理。</p>
<p><strong>总结：</strong></p>
<ul>
<li>Compose是一个定义和管理多容器的工具，使用Python语言编写</li>
<li>使用Compose配置文件描述多个容器应用的架构，比如使用什么镜像、数据卷、网络、映射端口等</li>
<li>然后一条命令管理所有服务，比如启动、停止、重启等</li>
</ul>
<h2 id="docker-compose作用"><a href="#docker-compose作用" class="headerlink" title="docker compose作用"></a>docker compose作用</h2><ul>
<li>使用 compose，我们可以通过 YAML 文件声明式的定义应用程序的各个服务，并由单个命令完成应用的创建和启动。 </li>
</ul>
<h2 id="ocker与docker-compose对比"><a href="#ocker与docker-compose对比" class="headerlink" title="ocker与docker-compose对比"></a>ocker与docker-compose对比</h2><ul>
<li><p>docker是自动化构建镜像，并启动镜像。 docker compose是自动化编排容器。</p>
</li>
<li><p>docker是基于Dockerfile得到images,启动的时候是一个单独的container</p>
</li>
<li><p>docker-compose是基于docker-compose.yml,通常启动的时候是一个服务，这个服务通常由多个container共同组成，并且端口，配置等由docker-compose定义好。</p>
</li>
<li><p>两者都需要安装，但是要使用docker-compose，必须已经安装docker</p>
</li>
</ul>
<h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node4 ~]<span class="comment"># curl -L https://github.com/docker/compose/releases/download/1.15.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class="line">[root@linux-node4 ~]<span class="comment"># chmod +x /usr/local/bin/docker-compose</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"></span><br><span class="line">pip install docker-compose</span><br></pre></td></tr></tbody></table></figure>



<h2 id="docker-compose配置文件解析"><a href="#docker-compose配置文件解析" class="headerlink" title="docker-compose配置文件解析"></a>docker-compose配置文件解析</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">'3'</span>                       <span class="comment"># cocker compose版本号</span></span><br><span class="line"></span><br><span class="line">services:                          <span class="comment"># 顶级配置文件(名称自己写)</span></span><br><span class="line">  mysql:                           <span class="comment"># 服务名: 容器建通信、管理容器（mysql这个容器取的名字，也是自己写的）</span></span><br><span class="line">    image: mysql:<span class="number">5.7</span>               <span class="comment"># 引入官方mysql镜像（可以大家自己的hub仓库，中大型公司都会自己搭建docker hub仓库）</span></span><br><span class="line">    volumes:</span><br><span class="line">      - ./mysql:/var/lib/mysql         <span class="comment"># 把当前文件夹下的 ./mysql文件夹挂载到docker容器 /var/lib/mysql 路径下</span></span><br><span class="line">    expose:</span><br><span class="line">      - <span class="string">"3306"</span>                        <span class="comment"># 将当前容器的端口3306端口暴露给link到本容器的容器</span></span><br><span class="line">    restart: always                   <span class="comment"># 宿主机重启自动拉起这个docker容器</span></span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=root             <span class="comment"># mysql服务器root密码root</span></span><br><span class="line">      - MYSQL_DATABASE=djangodocker          <span class="comment"># 创建数据库 djangodocker</span></span><br><span class="line">      - MYSQL_USER=django                    <span class="comment"># 创建一个用户 django</span></span><br><span class="line">      - MYSQL_PASSWORD=django                <span class="comment"># 用户密码为django</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 单独部署一个nginx</span><br><span class="line">  - 安装nginx服务</span><br><span class="line">  - 配置nginx.conf</span><br><span class="line">  - 配置 /etc/nginx/conf.d/*.conf</span><br><span class="line">  - 访问端口</span><br><span class="line"></span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:alpine</span><br><span class="line">    volumes:</span><br><span class="line">      - ./nginx/nginx.conf:/etc/nginx/nginx.conf</span><br><span class="line">      - ./nginx/conf:/etc/nginx/conf.d</span><br><span class="line">      - ./web/staticfiles:/django_static</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"80:80"</span>                             <span class="comment"># 绑定容器的80端口到主机的80端口</span></span><br><span class="line">    depends_on:</span><br><span class="line">      - web                                 <span class="comment"># 必须先启动web容器然才能启动nginx容器</span></span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    image: redis:alpine</span><br><span class="line">    expose:</span><br><span class="line">      - <span class="string">"6379"</span></span><br><span class="line">    restart: always</span><br><span class="line"></span><br><span class="line">  web:</span><br><span class="line">    build: .</span><br><span class="line">    <span class="comment"># command: python manage.py runserver 0:8000</span></span><br><span class="line">    <span class="comment"># ports:</span></span><br><span class="line">    <span class="comment">#   - "8000:8000"</span></span><br><span class="line">    command: uwsgi --ini uwsgi.ini             <span class="comment"># 启动uwsgi命令</span></span><br><span class="line">    working_dir: /code/web                     <span class="comment"># 项目工作路径</span></span><br><span class="line">    volumes:</span><br><span class="line">      - .:/code                                <span class="comment"># 将当前文件夹下所有文件挂载到容器的 /code 文件夹</span></span><br><span class="line">    expose:</span><br><span class="line">      - <span class="string">"8000"</span></span><br><span class="line">    depends_on:                                <span class="comment"># 必须mysql和reids容器启动后才能启动web容器</span></span><br><span class="line">      - mysql</span><br><span class="line">      - redis</span><br><span class="line"></span><br><span class="line">  celery:</span><br><span class="line">    build: .</span><br><span class="line">    command: celery -A web worker -l info</span><br><span class="line">    working_dir: /code/web</span><br><span class="line">    volumes:</span><br><span class="line">      - .:/code</span><br><span class="line">    depends_on:</span><br><span class="line">      - mysql</span><br><span class="line">      - redis</span><br></pre></td></tr></tbody></table></figure>







<h2 id="Docker-Compose常用命令"><a href="#Docker-Compose常用命令" class="headerlink" title="Docker-Compose常用命令"></a>Docker-Compose常用命令</h2><p> <strong>1、Docker-Compose命令格式</strong> </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker-compose [-f <arg>...] [options] [COMMAND] [ARGS...]</span><br><span class="line">命令选项如下：</span><br><span class="line">-f，–file FILE指定Compose模板文件，默认为docker-compose.yml，可以多次指定。</span><br><span class="line">-p，–project-name NAME指定项目名称，默认将使用所在目录名称作为项目名。</span><br><span class="line">-x-network-driver 使用Docker的可拔插网络后端特性（需要Docker <span class="number">1.9</span>+版本）</span><br><span class="line">-x-network-driver DRIVER指定网络后端的驱动，默认为bridge（需要Docker <span class="number">1.9</span>+版本）</span><br><span class="line">-verbose输出更多调试信息</span><br><span class="line">-v，–version打印版本并退出</span><br></pre></td></tr></tbody></table></figure>

<p><strong>2、docker-compose up</strong> </p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up [options] [--scale SERVICE=NUM...] [SERVICE...]</span><br><span class="line">选项包括：</span><br><span class="line">-d 在后台运行服务容器</span><br><span class="line">–no-color 不使用颜色来区分不同的服务的控制输出</span><br><span class="line">–no-deps 不启动服务所链接的容器</span><br><span class="line">–force-recreate 强制重新创建容器，不能与–no-recreate同时使用</span><br><span class="line">–no-recreate 如果容器已经存在，则不重新创建，不能与–force-recreate同时使用</span><br><span class="line">–no-build 不自动构建缺失的服务镜像</span><br><span class="line">–build 在启动容器前构建服务镜像</span><br><span class="line">–abort-on-container-exit 停止所有容器，如果任何一个容器被停止，不能与-d同时使用</span><br><span class="line">-t, –timeout TIMEOUT 停止容器时候的超时（默认为<span class="number">10</span>秒）</span><br><span class="line">–remove-orphans 删除服务中没有在compose文件中定义的容器</span><br><span class="line">–scale SERVICE=NUM 设置服务运行容器的个数，将覆盖在compose中通过scale指定的参数</span><br><span class="line">docker-compose up	启动所有服务</span><br><span class="line">docker-compose up -d	在后台所有启动服务</span><br><span class="line">-f 指定使用的Compose模板文件，默认为docker-compose.yml，可以多次指定。</span><br><span class="line">docker-compose -f docker-compose.yml up -d</span><br></pre></td></tr></tbody></table></figure>



<p><strong>3、docker-compose</strong></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">docker-compose ps 			<span class="comment">#列出项目中目前的所有容器</span></span><br><span class="line"></span><br><span class="line">docker-compose stop			<span class="comment">#停止正在运行的容器，可以通过docker-compose start 再次启动</span></span><br><span class="line"></span><br><span class="line">docker-compose -h			<span class="comment">#查看帮助</span></span><br><span class="line"></span><br><span class="line">docker-compose down			<span class="comment">#停用移除所有容器以及网络相关</span></span><br><span class="line"></span><br><span class="line">docker-compose logs			<span class="comment">#查看服务容器的输出</span></span><br><span class="line"></span><br><span class="line">docker-compose build			<span class="comment">#构建（重新构建）项目中的服务容器</span></span><br><span class="line"></span><br><span class="line">docker-compose pull			<span class="comment">#拉取服务依赖的镜像</span></span><br><span class="line"></span><br><span class="line">docker-compose restart			<span class="comment">#重启项目中的服务</span></span><br><span class="line"></span><br><span class="line">docker-compose rm			<span class="comment">#删除所有（停止状态的）服务容器。推荐先执行docker-compose stop命令来停止容器</span></span><br><span class="line"></span><br><span class="line">docker-compose rm -f			<span class="comment">#强制直接删除，包括非停止状态的容器</span></span><br><span class="line"></span><br><span class="line">docker-compose rm -v			<span class="comment">#删除容器所挂载的数据卷</span></span><br><span class="line"></span><br><span class="line">docker-compose start			<span class="comment">#启动已经存在的服务容器</span></span><br><span class="line"></span><br><span class="line">docker-compose pause			<span class="comment">#暂停一个服务容器</span></span><br><span class="line"></span><br><span class="line">docker-compose stop			<span class="comment">#显示各个容器运行的进程情况</span></span><br><span class="line"></span><br><span class="line">docker-compose unpause			<span class="comment">#恢复处于暂停状态中的服务</span></span><br><span class="line"></span><br><span class="line">docker-compose version			<span class="comment">#打印版本信息</span></span><br></pre></td></tr></tbody></table></figure>



<figure class="highlight"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">原文链接：https://blog.csdn.net/hanguofei/article/details/103016549</span><br></pre></td></tr></tbody></table></figure>

</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ares"
      src="/images/20160228201627_f5vax.png">
  <p class="site-author-name" itemprop="name">Ares</p>
  <div class="site-description" itemprop="description">最重要的是，别放弃希望</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://gitee.com/Aresea" title="GitHub → https:&#x2F;&#x2F;gitee.com&#x2F;Aresea" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/2441236144@qq.com" title="E-Mail → 2441236144@qq.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ares</span>
</div>

        








        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>














  

  

</body>
</html>
